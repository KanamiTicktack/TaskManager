<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Tasks</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/vue@3.2.45/dist/vue.global.prod.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
  
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover, maximum-scale=1.0">
  <meta name="theme-color" content="#6366f1">
  <link rel="manifest" href="./manifest.json">
  <link rel="apple-touch-icon" href="./icon-192.png">
  
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js').catch(err => console.log(err));
    }
  </script>

  <style>
    /* === Design System === */
    :root {
      --primary: #6366f1; --primary-hover: #4f46e5; --danger: #ef4444;
      --bg-body: #f3f4f6; --bg-card: #ffffff; --bg-input: #ffffff;
      --text-main: #1f2937; --text-sub: #6b7280; --border-color: #e5e7eb;
      --hover-bg: #f9fafb; --shadow: 0 1px 3px rgba(0,0,0,0.05);
      --radius: 12px; --tag-bg: #e9ecef; --tag-text: #495057;
      --status-bg: #1f2937; --status-text: #ffffff;
    }
    body.dark-mode {
      --primary: #818cf8; --primary-hover: #6366f1;
      --bg-body: #111827; --bg-card: #1f2937; --bg-input: #374151;
      --text-main: #f3f4f6; --text-sub: #9ca3af; --border-color: #374151;
      --hover-bg: #374151; --shadow: 0 4px 6px rgba(0,0,0,0.3);
      --tag-bg: #374151; --tag-text: #d1d5db;
      --status-bg: #f3f4f6; --status-text: #1f2937;
    }
    body { background-color: var(--bg-body); color: var(--text-main); font-family: 'Inter', sans-serif; overflow-y: scroll; -webkit-tap-highlight-color: transparent; }
    .form-control, .form-select, input, textarea { background-color: var(--bg-input); border-color: var(--border-color); color: var(--text-main); font-size: 16px !important; }
    body.dark-mode ::-webkit-calendar-picker-indicator { filter: invert(1); }
    
    /* Layout */
    .app-container { 
        display: flex; flex-direction: column; gap: 16px; 
        max-width: 1600px; margin: 0 auto; padding: 16px; min-height: 100vh; position: relative;
    }
    .split-layout { display: block; }
    
    /* ‚òÖPC Split Layout with Independent Scroll‚òÖ */
    @media (min-width: 992px) {
        .app-container {
            height: 100vh; /* Fix height to viewport */
            overflow: hidden; /* Stop body scroll */
            padding-bottom: 0;
        }
        .app-header {
            flex-shrink: 0; /* Header doesn't shrink */
        }
        .main-content {
            flex: 1;
            min-height: 0; /* Allow flex child to shrink */
            display: flex;
            flex-direction: column;
        }
        .split-layout { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 24px; 
            align-items: start;
            height: 100%; /* Fill remaining space */
            overflow: hidden;
        }
        .view-primary, .view-secondary { 
            display: block !important; 
            height: 100%; /* Full height of split area */
            overflow-y: auto; /* Independent scroll */
            padding-bottom: 100px; /* Space for FAB/Bottom */
            padding-right: 4px;
            
            /* Hide Scrollbar */
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        /* Hide Scrollbar for Chrome, Safari and Opera */
        .view-primary::-webkit-scrollbar, .view-secondary::-webkit-scrollbar {
            display: none;
        }
    }

    .app-card { background: var(--bg-card); border-radius: var(--radius); box-shadow: var(--shadow); border: 1px solid var(--border-color); margin-bottom: 16px; overflow: hidden; }
    
    /* Header */
    .app-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding: 0 4px; }
    .app-title { font-weight: 800; font-size: 1.5rem; margin: 0; color: var(--text-main); letter-spacing: -0.5px; }
    .btn-theme-toggle { background: transparent; border: none; color: var(--text-main); padding: 8px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: 0.2s; cursor: pointer; }
    .btn-theme-toggle:active { background: var(--hover-bg); transform: scale(0.95); }

    /* Tabs */
    .nav-tabs { border: none; gap: 8px; margin-bottom: 16px; flex-wrap: nowrap; overflow-x: auto; padding-bottom: 4px; }
    .nav-tabs::-webkit-scrollbar { display: none; }
    .nav-link { border: none; border-radius: 20px !important; color: var(--text-sub); font-weight: 600; padding: 8px 16px; cursor: pointer; white-space: nowrap; transition: 0.2s; font-size: 0.9rem; }
    .nav-link:hover { background: var(--hover-bg); color: var(--text-main); }
    .nav-link.active { background: var(--primary) !important; color: #fff !important; }
    
    /* Tasks */
    .task-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; margin-bottom: 8px; padding: 14px; display: flex; gap: 12px; cursor: pointer; position: relative; overflow: hidden; transition: 0.1s; align-items: flex-start; }
    .task-card:active { transform: scale(0.98); background: var(--hover-bg); }
    .task-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; }
    .priority-high::before { background: #ef4444; } .priority-medium::before { background: #f59e0b; } .priority-low::before { background: #3b82f6; }
    
    .custom-checkbox { width: 24px; height: 24px; border: 2px solid var(--text-sub); border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: 0.2s; margin-top: 2px; }
    .custom-checkbox.checked { background: var(--primary); border-color: var(--primary); }
    .custom-checkbox .material-icons-round { font-size: 18px; color: white; opacity: 0; transition: 0.2s; }
    .custom-checkbox.checked .material-icons-round { opacity: 1; }
    
    .task-content { flex: 1; min-width: 0; }
    .task-title { font-weight: 600; font-size: 1rem; margin-bottom: 6px; line-height: 1.4; word-break: break-word; }
    .task-meta { display: flex; gap: 6px; font-size: 0.75rem; color: var(--text-sub); flex-wrap: wrap; align-items: center; }
    .badge-base { padding: 3px 8px; border-radius: 6px; background: var(--hover-bg); border: 1px solid var(--border-color); display: flex; align-items: center; gap: 3px; font-weight: 500; }
    .tag-badge { background-color: var(--tag-bg); color: var(--tag-text); }
    .gcal-badge { background: #e0e7ff; color: #4338ca; border: none; }
    body.dark-mode .gcal-badge { background: #312e81; color: #e0e7ff; }
    .task-content.text-decoration-line-through { color: var(--text-sub); opacity: 0.7; }
    body.dark-mode .task-content.text-decoration-line-through { color: #9ca3af !important; opacity: 0.6; }
    
    /* Side Panel */
    .side-panel { 
        position: fixed; top: 0; right: 0; width: 100%; height: 100vh; 
        background: var(--bg-card); z-index: 3000; 
        display: flex; flex-direction: column; 
        box-shadow: -10px 0 30px rgba(0,0,0,0.1); 
        padding: 20px; overflow-y: auto;
    }
    .slide-enter-active, .slide-leave-active { transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
    .slide-enter-from, .slide-leave-to { transform: translateX(100%); }
    
    @media (min-width: 992px) {
        .side-panel { 
            position: fixed; top: 20px; right: 20px; width: 400px; height: calc(100vh - 40px); 
            border-radius: var(--radius); border: 1px solid var(--border-color); 
            z-index: 4000;
        }
        .slide-enter-active, .slide-leave-active { transition: opacity 0.2s ease; transform: none; }
        .slide-enter-from, .slide-leave-to { opacity: 0; transform: none; }
        .panel-header-mobile { display: none !important; }
        .panel-header-pc { display: flex !important; }
    }

    .panel-header-mobile { display: flex; align-items: center; gap: 12px; margin-bottom: 24px; padding-bottom: 12px; border-bottom: 1px solid var(--border-color); }
    .panel-header-pc { display: none !important; align-items: center; justify-content: space-between; margin-bottom: 24px; }
    .btn-panel-back { background: transparent; border: none; color: var(--text-main); padding: 8px; border-radius: 50%; display: flex; cursor: pointer; margin-left: -8px; }
    .btn-close { background: transparent; border: none; font-size: 1.5rem; line-height: 1; color: var(--text-sub); cursor: pointer; }

    /* Calendar */
    .calendar-wrapper { background: var(--bg-card); border-radius: var(--radius); border: 1px solid var(--border-color); margin-bottom: 20px; overflow: hidden; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, minmax(0, 1fr)); gap: 1px; background: var(--border-color); min-width: 300px; }
    .calendar-header-cell { padding: 12px 4px; text-align: center; font-size: 0.75rem; font-weight: 700; background: var(--hover-bg); color: var(--text-sub); }
    .header-sun { color: #ef4444; } .header-sat { color: #3b82f6; }
    .calendar-cell { background: var(--bg-card); padding: 4px; min-height: 100px; cursor: pointer; display: flex; flex-direction: column; transition: 0.1s; }
    .calendar-cell:active { background: var(--hover-bg); }
    .calendar-cell.selected { background: rgba(99, 102, 241, 0.1) !important; box-shadow: inset 0 0 0 2px var(--primary); }
    .date-num { align-self: center; width: 26px; height: 26px; display: flex; align-items: center; justify-content: center; font-size: 0.85rem; font-weight: 600; border-radius: 50%; margin-bottom: 4px; }
    .date-num.today { background: var(--primary); color: white; }
    .cal-item { font-size: 0.7rem; padding: 3px 6px; margin-bottom: 2px; border-radius: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; background: var(--bg-input); border: 1px solid var(--border-color); border-left-width: 3px; color: var(--text-main); }
    .cal-item.is-gcal { color: white; border: none; }
    .cal-item.completed { text-decoration: line-through; opacity: 0.6; }
    .dot { width: 6px; height: 6px; border-radius: 50%; background: var(--text-sub); margin: 1px; }
    
    /* FAB */
    .fab-btn { 
        position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; 
        border-radius: 20px; background: var(--primary); color: white; border: none; 
        box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4); 
        display: flex; justify-content: center; align-items: center; 
        z-index: 2000; cursor: pointer; transition: 0.2s; 
    }
    .fab-btn:active { transform: scale(0.92); }
    
    /* Inputs */
    .date-shortcut-btn { font-size: 0.75rem; padding: 6px 12px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-input); color: var(--text-sub); margin-right: 6px; transition: 0.2s; cursor: pointer; }
    .date-shortcut-btn:active { background: var(--hover-bg); }
    .priority-select-btn { border: 1px solid var(--border-color); background: var(--bg-input); color: var(--text-sub); padding: 10px; flex: 1; border-radius: 8px; text-align: center; font-size: 0.85rem; cursor: pointer; transition: 0.2s; }
    .priority-select-btn.active-high { background: rgba(239, 68, 68, 0.15); color: #ef4444; border-color: #ef4444; font-weight: bold; }
    .priority-select-btn.active-medium { background: rgba(245, 158, 11, 0.15); color: #f59e0b; border-color: #f59e0b; font-weight: bold; }
    .priority-select-btn.active-low { background: rgba(59, 130, 246, 0.15); color: #3b82f6; border-color: #3b82f6; font-weight: bold; }
    .priority-select-btn.active-none { background: var(--text-sub); color: white; border-color: var(--text-sub); }
    .tag-chip { font-size: 0.8rem; padding: 6px 12px; border-radius: 20px; background-color: var(--tag-bg); color: var(--tag-text); border: 1px solid var(--border-color); cursor: pointer; transition: 0.2s; display: inline-block; margin-right: 4px; margin-bottom: 4px; }
    
    /* Common */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(2px); transition: opacity 0.3s; }
    .modal-content { background: var(--bg-card); color: var(--text-main); width: 100%; max-width: 400px; border-radius: 16px; padding: 24px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); border: 1px solid var(--border-color); transform: scale(0.95); animation: modalPop 0.2s forwards; }
    .modal-actions { display: flex; justify-content: flex-end; gap: 12px; }
    .btn-modal { padding: 10px 20px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; transition: 0.2s; }
    .btn-cancel { background: transparent; color: var(--text-sub); }
    .btn-cancel:active { background: var(--hover-bg); color: var(--text-main); }
    .btn-confirm { background: var(--primary); color: white; }
    .btn-confirm:active { opacity: 0.8; }
    .btn-confirm.danger { background: var(--danger); }
    
    .loading-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 9998; display: flex; align-items: center; justify-content: center; flex-direction: column; color: white; }
    .spinner { width: 32px; height: 32px; border: 3px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 1s infinite linear; }
    .toast-notification { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #1f2937; color: white; padding: 12px 24px; border-radius: 50px; z-index: 3000; box-shadow: 0 4px 12px rgba(0,0,0,0.2); white-space: nowrap; font-weight: 500; }
    .status-indicator { position: fixed; bottom: 20px; left: 20px; background: var(--status-bg); color: var(--status-text); padding: 8px 16px; border-radius: 30px; font-size: 0.85rem; font-weight: 600; display: flex; align-items: center; gap: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 3000; }
    .status-spinner { width: 14px; height: 14px; border: 2px solid; border-radius: 50%; border-color: currentColor transparent transparent transparent; animation: spin 1s linear infinite; }
    .fade-enter-from, .fade-leave-to { opacity: 0; transform: translateY(10px); }
  </style>
</head>
<body>
<div id="app">
  <div v-if="loading" class="loading-overlay"><div class="spinner"></div><div class="mt-3 fw-bold">{{ loadingMessage }}</div></div>
  <transition name="toast"><div v-if="toast.show" class="toast-notification">{{ toast.message }}</div></transition>
  <transition name="fade">
    <div v-if="isSaving" class="status-indicator"><div class="status-spinner"></div><span>{{ pendingSave ? '‰øùÂ≠ò‰∏≠ („Ç≠„É•„ÉºÂæÖÊ©ü‰∏≠)...' : '‰øùÂ≠ò‰∏≠...' }}</span></div>
  </transition>

  <div v-if="modal.show" class="modal-overlay">
      <div class="modal-content">
          <div class="modal-title">{{ modal.title }}</div>
          <div class="modal-body">{{ modal.message }}</div>
          <div class="modal-actions">
              <button v-if="modal.type === 'confirm'" class="btn-modal btn-cancel" @click="closeModal(false)">„Ç≠„É£„É≥„Çª„É´</button>
              <button class="btn-modal btn-confirm" :class="{danger: modal.isDanger}" @click="closeModal(true)">{{ modal.okText }}</button>
          </div>
      </div>
  </div>

  <div class="app-container">
    <div class="app-header">
        <h1 class="app-title">Tasks</h1>
        <button class="btn-theme-toggle" @click="toggleDarkMode" title="Switch Theme">
            <span class="material-icons-round">{{ darkMode ? 'light_mode' : 'dark_mode' }}</span>
        </button>
    </div>

    <div class="main-content">
        <div class="split-layout">
            
            <div class="view-primary">
                <ul class="nav nav-tabs">
                    <li class="nav-item"><a class="nav-link" :class="{active: currentTab === 'active'}" @click.prevent="setTab('active')" href="#">Êú™ÂÆå‰∫Ü <span v-if="activeCount" class="badge bg-secondary rounded-pill ms-1">{{ activeCount }}</span></a></li>
                    <li class="nav-item"><a class="nav-link" :class="{active: currentTab === 'completed'}" @click.prevent="setTab('completed')" href="#">ÂÆå‰∫ÜÊ∏à</a></li>
                    <li class="nav-item" v-if="!isPC"><a class="nav-link" :class="{active: currentTab === 'calendar'}" @click.prevent="setTab('calendar')" href="#">„Ç´„É¨„É≥„ÉÄ„Éº</a></li>
                    <li class="nav-item"><a class="nav-link" :class="{active: currentTab === 'settings'}" @click.prevent="setTab('settings')" href="#">Ë®≠ÂÆö</a></li>
                </ul>

                <div v-if="currentTab !== 'settings'" class="d-flex justify-content-end mb-3">
                    <select class="form-select form-select-sm" v-model="filterTag" style="width: auto; max-width: 200px; border-radius: 20px;">
                        <option value="">üè∑Ô∏è „Åô„Åπ„Å¶„ÅÆ„Çø„Ç∞</option>
                        <option v-for="tag in allTagsList" :key="tag" :value="tag">#{{ tag.replace(/^#/, '') }}</option>
                    </select>
                </div>

                <transition name="fade" mode="out-in">
                    <div v-if="currentTab === 'settings'" key="settings">
                        <div class="app-card p-4">
                            <h5 class="fw-bold mb-4">Ë®≠ÂÆö</h5>
                            <h6 class="fw-bold text-secondary">Google„Ç´„É¨„É≥„ÉÄ„ÉºË°®Á§∫</h6>
                            <div class="border rounded p-3 mb-4" style="max-height: 200px; overflow-y: auto;">
                                <div v-if="availableCalendars.length === 0" class="text-muted small">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
                                <div v-for="cal in availableCalendars" :key="cal.id" class="form-check">
                                    <input class="form-check-input" type="checkbox" :value="cal.id" v-model="settings.calendarIds" @change="hasSettingsChanged=true">
                                    <label class="form-check-label small d-flex align-items-center"><span :style="{color: cal.color, fontSize:'20px', lineHeight:0}" class="me-2">‚óè</span> {{ cal.name }}</label>
                                </div>
                            </div>
                            <h6 class="fw-bold text-secondary">GitHubÈÄ£Êê∫</h6>
                            <div class="mb-2"><input type="password" v-model="settings.token" class="form-control" placeholder="Token" @input="hasSettingsChanged=true"></div>
                            <div class="row g-2 mb-2">
                                <div class="col-6"><input type="text" v-model="settings.owner" class="form-control" placeholder="Owner" @input="hasSettingsChanged=true"></div>
                                <div class="col-6"><input type="text" v-model="settings.repo" class="form-control" placeholder="Repo" @input="hasSettingsChanged=true"></div>
                            </div>
                            <input type="text" v-model="settings.path" class="form-control mb-3" placeholder="Path (e.g. Tasks.md)" @input="hasSettingsChanged=true">
                            <button class="btn btn-primary w-100 mb-4" @click="saveSettings" :disabled="!hasSettingsChanged">Ë®≠ÂÆö„Çí‰øùÂ≠ò</button>
                            <h6 class="fw-bold text-secondary">„Éá„Éº„ÇøÁÆ°ÁêÜ</h6>
                            <input type="text" v-model="settings.archivePath" class="form-control mb-2" placeholder="Archive Path">
                            <button class="btn btn-outline-warning w-100 btn-sm" @click="runArchiveProcess">ÂÆå‰∫Ü„Çø„Çπ„ÇØ„Çí„Ç¢„Éº„Ç´„Ç§„Éñ</button>
                        </div>
                    </div>

                    <div v-else-if="currentTab === 'active'" key="active">
                        <div v-if="groupedActiveTasks.length === 0" class="text-center py-5 text-muted"><span class="material-icons-round" style="font-size: 48px; opacity: 0.5;">task_alt</span><p class="mt-2">„Çø„Çπ„ÇØ„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</p></div>
                        <div v-for="group in groupedActiveTasks" :key="group.title" class="mb-4">
                            <h6 class="fw-bold text-secondary small mb-2 ms-1">{{ group.title }}</h6>
                            <div v-for="task in group.tasks" :key="task.lineIndex" class="task-card" :class="'priority-'+task.priority" @click="openEditPanel(task)">
                                <div class="custom-checkbox" @click.stop="toggleTask(task)"><span class="material-icons-round">check</span></div>
                                <div class="task-content">
                                    <div class="task-title" v-html="renderDesc(task.desc)"></div>
                                    <div class="task-meta">
                                        <span v-for="tag in task.tags" class="badge-base tag-badge">#{{ tag.replace(/^#/, '') }}</span>
                                        <span v-if="task.due" class="badge-base"><span class="material-icons-round" style="font-size:12px">event</span> {{ task.due }}</span>
                                        <span v-if="task.recurrence" class="badge-base">üîÅ {{ task.recurrence }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div v-else-if="currentTab === 'completed'" key="completed">
                        <div v-if="displayCompletedTasks.length === 0" class="text-center py-5 text-muted"><p>ÂÆå‰∫ÜÊ∏à„Åø„Çø„Çπ„ÇØ„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</p></div>
                        <div v-for="task in displayCompletedTasks" :key="task.uniqueId" class="task-card opacity-75">
                            <div class="custom-checkbox checked" @click.stop="confirmRestore(task)"><span class="material-icons-round">check</span></div>
                            <div class="task-content text-decoration-line-through">
                                <div class="task-title" v-html="renderDesc(task.desc)"></div>
                                <div class="task-meta">
                                    <span v-if="task.isArchived" class="badge bg-secondary text-white" style="font-size:0.6rem">Archived</span>
                                    <span v-for="tag in task.tags" class="badge-base tag-badge">#{{ tag.replace(/^#/, '') }}</span>
                                    Done: {{ task.doneDate }}
                                </div>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn-restore" @click.stop="confirmRestore(task)"><span class="material-icons-round" style="font-size:16px">undo</span></button>
                                <button class="btn-delete p-1 rounded" @click.stop="confirmDelete(task)"><span class="material-icons-round" style="font-size:20px">delete</span></button>
                            </div>
                        </div>
                        <div v-if="displayCompletedTasks.length < allCompletedTasks.length" class="text-center mt-3"><button class="btn btn-sm btn-outline-secondary" @click="loadMoreCompleted">„ÇÇ„Å£„Å®Ë¶ã„Çã</button></div>
                    </div>
                </transition>
            </div>

            <div class="view-secondary" v-if="currentTab === 'calendar' || isPC">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="btn-group shadow-sm">
                        <button class="btn btn-sm btn-light border" :class="{active: calendarMode==='week'}" @click="calendarMode='week'">ÈÄ±</button>
                        <button class="btn btn-sm btn-light border" :class="{active: calendarMode==='month'}" @click="calendarMode='month'">Êúà</button>
                    </div>
                    <div class="d-flex align-items-center gap-2 bg-white rounded shadow-sm px-2 py-1 border" style="background-color: var(--bg-card) !important; border-color: var(--border-color) !important;">
                        <button class="btn btn-sm btn-light" @click="changeDateRange(-1)">‚óÄ</button><span class="fw-bold small px-2">{{ calendarTitle }}</span><button class="btn btn-sm btn-light" @click="changeDateRange(1)">‚ñ∂</button>
                    </div>
                </div>
                <div class="calendar-wrapper">
                    <div class="calendar-grid">
                        <div v-for="d in ['Êó•','Êúà','ÁÅ´','Ê∞¥','Êú®','Èáë','Âúü']" class="calendar-header-cell" :class="{'header-sun':d=='Êó•','header-sat':d=='Âúü'}">{{ d }}</div>
                        <div v-for="(day, idx) in calendarDays" :key="idx" class="calendar-cell" :class="[{'selected': day.date === selectedDate}]" :style="{ minHeight: calendarMode === 'month' ? '80px' : '150px' }" @click="selectDate(day.date)">
                            <div class="date-num" :class="{today: day.isToday}">{{ day.dayNum }}</div>
                            <div v-if="calendarMode === 'week'">
                                <div v-for="item in day.items" class="cal-item" :class="{'is-gcal': item.isGCal, 'completed': item.completed}" :style="item.isGCal ? {background: item.color} : {borderLeftColor: getPriorityColor(item.priority)}">{{ item.desc }}</div>
                            </div>
                            <div v-else class="dot-container">
                                <div v-for="item in day.items" class="dot" :style="item.isGCal ? {background: item.color, width:'7px', height:'7px'} : {background: getPriorityColor(item.priority)}"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="app-card p-0" v-if="selectedDate">
                    <div class="p-3 border-bottom d-flex justify-content-between align-items-center" style="background-color: var(--hover-bg);"><h6 class="m-0 fw-bold">{{ selectedDateDisplay }}</h6><div class="d-flex gap-2"><button class="btn btn-sm btn-outline-primary" @click="openAddGCalPanel(selectedDate)">+ ‰∫àÂÆö</button><button class="btn btn-sm btn-primary" @click="openAddPanelWithDate(selectedDate)">+ „Çø„Çπ„ÇØ</button></div></div>
                    <div class="p-2">
                        <div v-if="selectedDateItems.length === 0" class="text-center py-4 text-muted small">‰∫àÂÆö„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>
                        <div v-for="item in selectedDateItems" :key="item.uniqueId" class="task-card border-0 mb-1" :style="item.isGCal ? {background: 'var(--hover-bg)'} : {}" @click="openEditPanel(item)">
                            <div v-if="item.isGCal" class="me-2"><span class="material-icons-round" :style="{color: item.color}">event</span></div>
                            <div v-else class="custom-checkbox me-2" :class="{checked: item.completed}" @click.stop="toggleTask(item)"><span class="material-icons-round">check</span></div>
                            <div class="task-content">
                                <div class="task-title" :class="{'text-decoration-line-through text-muted': item.completed}" v-html="renderDesc(item.isGCal ? item.title : item.desc)"></div>
                                <div class="task-meta">
                                    <span v-if="item.isGCal" class="badge-base" :style="{background: item.color, color:'white'}">{{ item.calendarName }}</span>
                                    <span v-if="item.isGCal">{{ item.isAllDay ? 'ÁµÇÊó•' : item.timeStr }}</span>
                                    <span v-if="!item.isGCal && item.priority!='none'" class="fw-bold" :style="{color: getPriorityColor(item.priority)}">Prior: {{ item.priority }}</span>
                                    <span v-if="!item.isGCal" v-for="tag in item.tags" class="badge-base tag-badge">#{{ tag.replace(/^#/, '') }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div><transition name="slide">
      <div v-if="showPanel" class="side-panel">
        <div class="panel-header-mobile">
            <button class="btn-panel-back" @click="closePanel"><span class="material-icons-round">arrow_back</span></button>
            <h5 class="fw-bold m-0 flex-grow-1">{{ isEditMode ? 'Á∑®ÈõÜ' : 'Êñ∞Ë¶è‰ΩúÊàê' }}</h5>
            <button class="btn-close" @click="closePanel">√ó</button>
        </div>
        <div class="d-flex justify-content-between mb-4 panel-header-pc">
          <h5 class="fw-bold m-0">{{ isEditMode ? 'Á∑®ÈõÜ' : 'Êñ∞Ë¶è‰ΩúÊàê' }}</h5>
          <button class="btn-close" @click="closePanel">√ó</button>
        </div>

        <div v-if="panelData.isGCal" class="d-flex flex-column h-100">
            <div class="mb-3" v-if="panelData.isNew">
                <label class="small fw-bold text-secondary">„Ç´„É¨„É≥„ÉÄ„Éº</label>
                <select class="form-select" v-model="panelData.targetCalendarId"><option v-for="cal in availableCalendars" :value="cal.id">{{ cal.name }}</option></select>
            </div>
            <input type="text" v-model="panelData.title" class="form-control fw-bold fs-5 mb-3" placeholder="„Çø„Ç§„Éà„É´">
            
            <div class="mb-3">
                <label class="small fw-bold text-secondary mb-1">Êó•‰ªò</label>
                <input type="date" v-model="panelData.dateInput" class="form-control text-center" style="font-size: 1.1rem;">
            </div>
            
            <div class="row g-2 mb-3">
                <div class="col-6">
                    <label class="small fw-bold text-secondary mb-1">ÈñãÂßã</label>
                    <div class="d-flex align-items-center gap-1">
                        <select v-model="panelData.startHour" class="form-select text-center p-1"><option v-for="h in hours" :value="h">{{h}}</option></select>
                        <span>:</span>
                        <select v-model="panelData.startMin" class="form-select text-center p-1"><option v-for="m in minutes" :value="m">{{m}}</option></select>
                    </div>
                </div>
                <div class="col-6">
                    <label class="small fw-bold text-secondary mb-1">ÁµÇ‰∫Ü</label>
                    <div class="d-flex align-items-center gap-1">
                        <select v-model="panelData.endHour" class="form-select text-center p-1"><option value="">--</option><option v-for="h in hours" :value="h">{{h}}</option></select>
                        <span>:</span>
                        <select v-model="panelData.endMin" class="form-select text-center p-1"><option value="">--</option><option v-for="m in minutes" :value="m">{{m}}</option></select>
                    </div>
                </div>
            </div>
            
            <div class="mb-3">
                <label class="small fw-bold text-secondary mb-1">‰ºöË≠∞URL</label>
                <input type="url" v-model="panelData.meetingUrl" class="form-control" placeholder="https://...">
            </div>

            <textarea v-model="panelData.desc" class="form-control flex-grow-1" placeholder="„É°„É¢"></textarea>
            <div class="mt-3 d-flex gap-2">
                <button class="btn btn-outline-secondary flex-grow-1 py-2" @click="closePanel">„Ç≠„É£„É≥„Çª„É´</button>
                <button class="btn btn-primary flex-grow-1 py-2" @click="saveGCalEvent">‰øùÂ≠ò</button>
            </div>
        </div>

        <div v-else class="d-flex flex-column h-100">
            <label class="small fw-bold text-secondary mb-1">„Çø„Çπ„ÇØÂêç</label>
            <textarea v-model="panelData.desc" class="form-control fw-bold fs-6 mb-4" rows="3" placeholder="‰Ωï„Çí„Åô„ÇãÔºü"></textarea>
            <div class="row g-4 mb-4">
                <div class="col-12 col-sm-6 border-end-sm" style="border-color: var(--border-color) !important;">
                    <label class="small fw-bold text-secondary mb-2">„Çπ„Ç±„Ç∏„É•„Éº„É´</label>
                    <input type="date" v-model="panelData.due" class="form-control form-control-sm mb-2">
                    <div class="d-flex gap-1 mb-3"><button class="date-shortcut-btn" @click="setDateShortcut(0)">‰ªäÊó•</button><button class="date-shortcut-btn" @click="setDateShortcut(1)">ÊòéÊó•</button></div>
                    <label class="small fw-bold text-secondary mb-1">Áπ∞„ÇäËøî„Åó</label>
                    <input type="text" v-model="panelData.recurrence" class="form-control form-control-sm" placeholder="every week" list="recurrenceOptions">
                </div>
                <div class="col-12 col-sm-6">
                    <label class="small fw-bold text-secondary mb-2">ÂÑ™ÂÖàÂ∫¶</label>
                    <div class="d-flex flex-column gap-2 mb-3">
                        <div class="btn-group w-100" role="group">
                            <button class="priority-select-btn" :class="{'active-high': panelData.priority==='high'}" @click="panelData.priority='high'">È´ò</button>
                            <button class="priority-select-btn" :class="{'active-medium': panelData.priority==='medium'}" @click="panelData.priority='medium'">‰∏≠</button>
                            <button class="priority-select-btn" :class="{'active-low': panelData.priority==='low'}" @click="panelData.priority='low'">‰Ωé</button>
                        </div>
                        <button class="priority-select-btn active-none" v-if="panelData.priority==='none'" @click="panelData.priority='medium'">„Å™„Åó</button>
                        <button class="priority-select-btn" v-else @click="panelData.priority='none'">„ÇØ„É™„Ç¢</button>
                    </div>
                    <label class="small fw-bold text-secondary mb-1">„Çø„Ç∞</label>
                    <div class="input-group input-group-sm mb-2"><span class="input-group-text bg-transparent border-end-0">#</span><input type="text" class="form-control border-start-0 ps-0" v-model="tagInput" @keydown.enter.prevent="addTag" placeholder="New"><button class="btn btn-outline-secondary" @click="addTag">+</button></div>
                    <div class="d-flex flex-wrap gap-1 mb-2"><span v-for="tag in panelData.tags" :key="tag" class="badge bg-primary d-flex align-items-center gap-1" style="cursor:pointer" @click="removeTag(tag)">{{ tag.replace(/^#/, '') }} <span class="material-icons-round" style="font-size:10px">close</span></span></div>
                </div>
            </div>
            <div class="mb-3">
                <label class="small fw-bold text-secondary mb-1">„Çà„Åè‰Ωø„ÅÜ„Çø„Ç∞ (History)</label>
                <div class="d-flex flex-wrap gap-1 p-2 border rounded" style="background: var(--bg-input); min-height: 40px; border-color: var(--border-color) !important;">
                    <div v-if="suggestedTags.length === 0" class="text-muted small">Â±•Ê≠¥„Å™„Åó</div>
                    <span v-for="tag in suggestedTags" :key="tag" class="tag-chip" @click="addTagFromHistory(tag)">#{{ tag.replace(/^#/, '') }}</span>
                </div>
            </div>
            <div class="mt-auto">
                <label class="small fw-bold text-secondary mb-1">URL (‰ªªÊÑè)</label>
                <input type="url" v-model="panelData.url" class="form-control form-control-sm mb-3 text-muted" placeholder="https://...">
                <div class="d-flex gap-2">
                    <button class="btn btn-delete flex-grow-0" @click="confirmDelete(panelData.taskRef)" v-if="isEditMode" title="ÂâäÈô§"><span class="material-icons-round">delete</span></button>
                    <button class="btn btn-outline-secondary flex-grow-1 py-2" @click="closePanel">„Ç≠„É£„É≥„Çª„É´</button>
                    <button class="btn btn-primary flex-grow-1 py-2" @click="saveTaskChanges">‰øùÂ≠ò</button>
                </div>
            </div>
        </div>
      </div>
    </transition>
    
    <button v-if="!showPanel && (!isPC || currentTab === 'active')" class="fab-btn" @click="openAddPanel"><span class="material-icons-round">add</span></button>
    <datalist id="recurrenceOptions"><option value="every day"></option><option value="every week"></option></datalist>
  </div> 
</div>

<script>
// ==========================================
//  ‚òÖ‚òÖ‚òÖ Ë®≠ÂÆöÔºöGAS Web App URL ‚òÖ‚òÖ‚òÖ
// ==========================================
const CONST_GAS_URL = "https://script.google.com/macros/s/AKfycbxd-vue3AV2zTLZ5abQVw287UD6fVXj44E0_9kzBW6P5EILSTua0q3EBKLd9MzSd6HNjw/exec"; 

async function callGAS(action, params = {}) {
  const finalParams = { ...params, action: action };
  const response = await fetch(CONST_GAS_URL, {
    method: 'POST',
    body: JSON.stringify(finalParams)
  });
  const json = await response.json();
  if (json.error) throw new Error(json.error);
  return json;
}

const { createApp } = Vue;

createApp({
  data() {
    return {
      loading: false, isSaving: false, loadingMessage: 'Loading...', 
      currentTab: 'active',
      isPC: window.innerWidth >= 992,
      settings: { token: '', owner: '', repo: '', path: '', archivePath: '', calendarIds: [] },
      hasSettingsChanged: false, darkMode: false, 
      
      rawContent: '', sha: '', lines: [], tasks: [], archiveTasks: [],
      
      calendarMode: 'week', selectedDate: '', currentCalStart: new Date(), 
      gcalEvents: [], availableCalendars: [], 

      showPanel: false, isEditMode: false,
      panelData: { id: null, desc: '', due: '', priority: 'none', completed: false, tags: [], isGCal: false, 
                   startHour: '09', startMin: '00', endHour: '', endMin: '', meetingUrl: '' },
      tagInput: '', allTagsList: [], filterTag: '', 
      touchStartX: 0, touchEndX: 0, swipeIgnore: false, displayLimit: 30, touchStartY: 0, touchEndY: 0, 
      
      modal: { show: false, title: '', message: '', type: 'info', okText: 'OK', isDanger: false, resolve: null },
      toast: { show: false, message: '' },
      pendingSave: false,
      
      hours: Array.from({length:24}, (_,i)=>String(i).padStart(2,'0')),
      minutes: ['00', '15', '30', '45']
    }
  },
  computed: {
    tabs() {
        return [
            { id: 'active', label: 'Êú™ÂÆå‰∫Ü', count: this.tasks.filter(t=>!t.completed).length },
            { id: 'completed', label: 'ÂÆå‰∫ÜÊ∏à' },
            { id: 'calendar', label: '„Ç´„É¨„É≥„ÉÄ„Éº' },
            { id: 'settings', label: 'Ë®≠ÂÆö' }
        ];
    },
    activeCount() { return this.tasks.filter(t => !t.completed).length; },
    allCompletedTasks() {
      const main = this.tasks.filter(t => t.completed && (!this.filterTag || t.tags.includes(this.filterTag))).map(t => ({...t, isArchived: false, uniqueId: 'm-'+t.lineIndex}));
      const arch = this.archiveTasks.filter(t => !this.filterTag || t.tags.includes(this.filterTag)).map((t,i) => ({...t, isArchived: true, uniqueId: 'a-'+i}));
      main.sort((a, b) => (a.doneDate < b.doneDate ? 1 : -1));
      arch.sort((a, b) => (a.doneDate < b.doneDate ? 1 : -1));
      return [...main, ...arch];
    },
    displayCompletedTasks() { return this.allCompletedTasks.slice(0, this.displayLimit); },
    selectedDateItems() {
      if (!this.selectedDate) return [];
      const dateStr = this.selectedDate;
      const dayTasks = this.tasks.filter(t => t.due === dateStr && (!this.filterTag || t.tags.includes(this.filterTag)))
                                 .map(t => ({...t, isGCal: false, uniqueId: 'task-'+t.lineIndex}));
      const dayGcals = this.gcalEvents.filter(e => this.convertIsoToYMD(e.start) === dateStr)
                                    .map(e => ({...e, isGCal: true, uniqueId: 'gcal-'+e.id, desc: e.desc, title: e.title, timeStr: this.formatTimeRange(e)}));
      return [...dayGcals, ...dayTasks].sort((a, b) => {
          if (a.isGCal && !b.isGCal) return -1; 
          if (!a.isGCal && b.isGCal) return 1;
          const tA = a.isGCal ? (a.isAllDay ? '00:00' : a.start) : (a.due + 'T00:00');
          const tB = b.isGCal ? (b.isAllDay ? '00:00' : b.start) : (b.due + 'T00:00');
          return tA > tB ? 1 : -1;
      });
    },
    calendarTitle() {
      const d = new Date(this.currentCalStart);
      if (this.calendarMode === 'week') {
        const start = new Date(d); start.setDate(d.getDate() - d.getDay()); 
        const end = new Date(start); end.setDate(start.getDate() + 6);
        return `${start.getMonth()+1}/${start.getDate()} - ${end.getMonth()+1}/${end.getDate()}`;
      } else {
        return `${d.getFullYear()}Âπ¥ ${d.getMonth()+1}Êúà`;
      }
    },
    calendarDays() {
      const days = [];
      const d = new Date(this.currentCalStart);
      const todayStr = this.getTodayStr(); 
      let startDate; let count = 0;
      if (this.calendarMode === 'week') {
        startDate = new Date(d); startDate.setDate(d.getDate() - d.getDay()); count = 7;
      } else {
        startDate = new Date(d.getFullYear(), d.getMonth(), 1); startDate.setDate(startDate.getDate() - startDate.getDay()); count = 42; 
      }
      for (let i = 0; i < count; i++) {
        const date = new Date(startDate); date.setDate(startDate.getDate() + i);
        const dateStr = this.getLocalYMD(date);
        const dayTasks = this.tasks.filter(t => t.due === dateStr && (!this.filterTag || t.tags.includes(this.filterTag))).map(t => ({...t, isGCal: false}));
        const dayGcals = this.gcalEvents.filter(e => this.convertIsoToYMD(e.start) === dateStr).map(e => ({...e, isGCal: true, desc: e.title}));
        days.push({
          date: dateStr, dayNum: date.getDate(), dayOfWeek: date.getDay(), isToday: dateStr === todayStr,
          items: [...dayGcals, ...dayTasks] 
        });
      }
      return days;
    },
    suggestedTags() { 
        const s = new Set(); 
        this.allTagsList.forEach(t => {
            if(!this.panelData.tags.includes(t) && t.toLowerCase() !== 'todo' && t.toLowerCase() !== '#todo') s.add(t);
        });
        return Array.from(s); 
    },
    groupedActiveTasks() {
      const today = this.getTodayStr();
      const todayGroup = { title: '‰ªäÊó• & ÊúüÈôêÂàá„Çå', tasks: [] };
      const noDateGroup = { title: 'ÊúüÈôê„Å™„Åó', tasks: [] };
      const futureGroups = {};
      const filteredTasks = this.tasks.filter(t => !t.completed && (!this.filterTag || t.tags.includes(this.filterTag)));
      filteredTasks.forEach(task => {
        if (!task.due) noDateGroup.tasks.push(task);
        else if (task.due <= today) todayGroup.tasks.push(task);
        else { if (!futureGroups[task.due]) futureGroups[task.due] = []; futureGroups[task.due].push(task); }
      });
      const result = [];
      if (todayGroup.tasks.length > 0) result.push(todayGroup);
      Object.keys(futureGroups).sort().forEach(date => {
        result.push({ title: date, tasks: futureGroups[date] });
      });
      if (noDateGroup.tasks.length > 0) result.push(noDateGroup);
      return result;
    },
    selectedDateDisplay() {
        if (!this.selectedDate) return '';
        const d = new Date(this.selectedDate);
        return `${d.getMonth()+1}/${d.getDate()} (${['Êó•','Êúà','ÁÅ´','Ê∞¥','Êú®','Èáë','Âúü'][d.getDay()]})`;
    }
  },
  watch: {
    calendarMode() { this.fetchGCal(); },
    currentCalStart() { this.fetchGCal(); },
    darkMode(val) {
        if(val) { document.body.classList.add('dark-mode'); localStorage.setItem('obsidian_tasks_theme', 'dark'); }
        else { document.body.classList.remove('dark-mode'); localStorage.setItem('obsidian_tasks_theme', 'light'); }
    }
  },
  mounted() {
    this.selectedDate = this.getTodayStr();
    window.addEventListener('resize', this.handleResize);
    const saved = localStorage.getItem('gh_tasks_settings');
    const savedTheme = localStorage.getItem('obsidian_tasks_theme');
    if (savedTheme === 'dark') { this.darkMode = true; document.body.classList.add('dark-mode'); }
    if (saved) {
        this.settings = JSON.parse(saved);
        this.loadData();
    } else {
        this.currentTab = 'settings';
    }
  },
  beforeUnmount() {
    window.removeEventListener('resize', this.handleResize);
  },
  methods: {
    handleResize() {
        this.isPC = window.innerWidth >= 992;
        if(this.isPC && this.currentTab === 'calendar') this.currentTab = 'active';
    },
    addTag() { 
        let val = this.tagInput.trim();
        if(!val) return;
        if(!val.startsWith('#')) val = '#' + val;
        if(!this.panelData.tags.includes(val)) { 
            this.panelData.tags.push(val); 
            this.tagInput = ''; 
        } 
    },
    parseContent(text) {
      this.lines = text.split('\n'); this.tasks = []; const foundTags = new Set(); 
      this.lines.forEach((line, index) => {
        const match = line.match(/^[-*]\s*\[([xX ])\]\s*(.*)/);
        if (match) {
          let body = match[2];
          const completed = match[1].toLowerCase() === 'x';
          const due = (body.match(/üìÖ\s*(\d{4}-\d{2}-\d{2})/) || [])[1] || '';
          const created = (body.match(/‚ûï\s*(\d{4}-\d{2}-\d{2})/) || [])[1] || '';
          const recurrence = (body.match(/üîÅ\s*([^‚úÖ‚ûïüìÖ#\n\r]+)/) || [])[1] ? (body.match(/üîÅ\s*([^‚úÖ‚ûïüìÖ#\n\r]+)/) || [])[1].trim() : '';
          let priority = 'none'; if(body.includes('‚è´')) priority='high'; else if(body.includes('üîº')) priority='medium'; else if(body.includes('üîΩ')) priority='low';
          const tags = [];
          let tempBody = body.replace(/\[.*?\]\(.*?\)/g, '').replace(/https?:\/\/\S+/g, '');
          (tempBody.match(/#[^\s#]+/g) || []).forEach(t => {
              let tag = t.replace(/[.,!?:;)}\]]+$/, '');
              if(tag.toLowerCase() !== '#todo' && !tag.includes('=') && tag.length > 1) {
                tags.push(tag); foundTags.add(tag);
              }
          });
          let desc = body.replace(/üìÖ\s*\d{4}-\d{2}-\d{2}|‚úÖ\s*\d{4}-\d{2}-\d{2}|üîÅ\s*[^‚úÖ‚ûïüìÖ#\n\r]+|‚ûï\s*\d{4}-\d{2}-\d{2}|‚è´|üîº|üîΩ/g, '');
          tags.forEach(t => desc = desc.replace(new RegExp(`(^|\\s)${t.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}(?=\\s|$)`, 'g'), ' '));
          desc = desc.replace(/#todo/gi, '').trim();
          this.tasks.push({ lineIndex: index, originalLine: line, desc, due, recurrence, priority, created, completed, tags });
        }
      });
      this.allTagsList = Array.from(foundTags).sort();
    },
    openAddPanel() { this.openAddPanelWithDate(this.getTodayStr()); },
    closePanel() { this.showPanel = false; },
    openAddGCalPanel(d) { 
        try {
            this.isEditMode = false; this.showPanel = true; 
            const now = new Date();
            const curH = String(now.getHours()).padStart(2,'0');
            this.panelData = { isGCal: true, isNew: true, title: '', desc: '', dateInput: d, startHour: curH, startMin: '00', endHour: '', endMin: '', targetCalendarId: this.settings.calendarIds[0]||'', meetingUrl: '' }; 
        } catch(e) { console.error(e); }
    },
    setTab(id) {
      this.currentTab = id;
      if (id === 'completed' && this.archiveTasks.length === 0 && this.settings.archivePath) {
        this.loadArchiveData();
      }
    },
    toggleDarkMode() { 
        if(this.darkMode) { this.darkMode = false; document.body.classList.remove('dark-mode'); localStorage.setItem('obsidian_tasks_theme', 'light'); } 
        else { this.darkMode = true; document.body.classList.add('dark-mode'); localStorage.setItem('obsidian_tasks_theme', 'dark'); } 
    },
    async saveSettings() {
      localStorage.setItem('gh_tasks_settings', JSON.stringify(this.settings));
      this.showToastNotification('Ë®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
      this.hasSettingsChanged = false;
      this.loadData();
    },
    async loadData() {
      this.loading = true;
      try {
          const res = await callGAS('getFileContent', this.settings);
          this.rawContent = res.content; this.sha = res.sha;
          this.parseContent(res.content);
          this.fetchGCal();
          this.loading = false;
          if(this.currentTab === 'settings') this.currentTab = 'active';
          const cals = await callGAS('getAvailableCalendars', {});
          this.availableCalendars = cals;
      } catch(e) {
          this.showInfo('Error', e.toString()); this.loading = false;
      }
    },
    async loadArchiveData() {
        if(!this.settings.archivePath) return;
        try {
            const res = await callGAS('getFileContent', { ...this.settings, path: this.settings.archivePath });
            if(!res.content) return;
            const lines = res.content.split('\n');
            this.archiveTasks = [];
            lines.forEach((l, i) => {
                const m = l.match(/^[-*]\s*\[([xX])\]\s*(.*)/);
                if(m) {
                    let body = m[2];
                    const doneDate = (body.match(/‚úÖ\s*(\d{4}-\d{2}-\d{2})/) || [])[1] || '';
                    const tags = []; 
                    let tempBody = body.replace(/\[.*?\]\((.*?)\)/g, '').replace(/https?:\/\/[^\s]+/g, '');
                    (tempBody.match(/#[^\s#]+/g) || []).forEach(t => {
                        let tag = t.replace(/[.,!?:;)}\]]+$/, '');
                        if(tag.toLowerCase()!=='#todo' && !tag.includes('=') && tag.length>1) tags.push(tag);
                    });
                    let desc = body.replace(/üìÖ\s*\d{4}-\d{2}-\d{2}|‚úÖ\s*\d{4}-\d{2}-\d{2}|üîÅ\s*[^‚úÖ‚ûïüìÖ#\n\r]+|‚ûï\s*\d{4}-\d{2}-\d{2}|‚è´|üîº|üîΩ/g, '');
                    tags.forEach(t => desc = desc.replace(new RegExp(`(^|\\s)${t.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}(?=\\s|$)`, 'g'), ' '));
                    desc = desc.replace(/#todo/gi, '').trim();
                    this.archiveTasks.push({ desc: desc.trim(), doneDate, completed: true, tags, originalLine: l });
                }
            });
        } catch(e) { console.error('Archive Load Error:', e); }
    },
    async fetchGCal() {
       if(!this.settings.calendarIds || this.settings.calendarIds.length === 0) return;
       const params = {
           startStr: this.calendarDays[0].date,
           endStr: this.calendarDays[this.calendarDays.length-1].date,
           calendarIds: JSON.stringify(this.settings.calendarIds)
       };
       try {
           const res = await callGAS('getCalendarEvents', params);
           if(res.events) this.gcalEvents = res.events;
       } catch(e) { console.error(e); }
    },
    async saveGCalEvent() {
      this.isSaving = true;
      const dateStr = this.panelData.dateInput; 
      const timeStart = (this.panelData.startHour && this.panelData.startMin) ? `${this.panelData.startHour}:${this.panelData.startMin}` : '';
      let timeEnd = (this.panelData.endHour && this.panelData.endMin) ? `${this.panelData.endHour}:${this.panelData.endMin}` : '';
      if (timeStart && !timeEnd) {
          const h = parseInt(this.panelData.startHour);
          const nextH = (h + 1) % 24;
          timeEnd = `${String(nextH).padStart(2,'0')}:${this.panelData.startMin}`;
      }
      
      let finalDesc = this.panelData.desc || '';
      if (this.panelData.meetingUrl && this.panelData.meetingUrl.trim()) {
          finalDesc = "„Äê‰ºöË≠∞URL„Äë: " + this.panelData.meetingUrl + "\n\n" + finalDesc;
      }

      const params = { 
          ...this.panelData, dateStr, startTime: timeStart, endTime: timeEnd, 
          calendarId: this.panelData.calendarId, eventId: this.panelData.eid, 
          description: finalDesc, 
          desc: finalDesc 
      };
      
      try {
          if (this.panelData.isNew) await callGAS('createCalendarEvent', params);
          else await callGAS('updateCalendarEvent', params);
          this.isSaving = false; this.closePanel(); this.fetchGCal();
      } catch(e) { this.isSaving = false; this.showInfo('Error', e); }
    },
    async fetchFileContent(path) {
        return callGAS('getFileContent', { ...this.settings, path: path });
    },
    async saveFileContentPromise(path, content, sha) {
        return callGAS('saveFileContent', { ...this.settings, path: path, content: content, sha: sha });
    },
    pushChanges(silent = false) {
      if (this.isSaving) { this.pendingSave = true; return; }
      if (!silent) this.isSaving = true;
      
      const newLines = [...this.lines];
      this.tasks.forEach(t => {
        const cb = t.completed ? '- [x]' : '- [ ]';
        const cr = t.created ? ` ‚ûï ${t.created}` : ''; const du = t.due ? ` üìÖ ${t.due}` : ''; const re = t.recurrence ? ` üîÅ ${t.recurrence}` : '';
        let pr = ''; if (t.priority === 'high') pr = ' ‚è´'; else if (t.priority === 'medium') pr = ' üîº'; else if (t.priority === 'low') pr = ' üîΩ';
        let do_ = ''; if (t.doneDate) do_ = ` ‚úÖ ${t.doneDate}`; else if (t.completed) do_ = ` ‚úÖ ${this.getTodayStr()}`;
        const tags = t.tags.length > 0 ? ' ' + t.tags.join(' ') : '';
        const tagStr = tags.includes('#todo') ? tags : ` #todo${tags}`;
        const line = `${cb} ${t.desc}${pr}${re}${do_}${tagStr}${cr}${du}`.replace(/\s+/g, ' ');
        if (t.lineIndex >= 0) newLines[t.lineIndex] = line;
        else { newLines.push(line); t.lineIndex = newLines.length - 1; }
      });
      const content = newLines.join('\n');
      
      this.saveFileContentPromise(this.settings.path, content, this.sha)
      .then(res => {
          this.sha = res.newSha; this.lines = newLines; 
          if (this.pendingSave) { this.pendingSave = false; this.isSaving = false; this.pushChanges(true); } 
          else { this.isSaving = false; if(!silent) this.showToastNotification('‰øùÂ≠ò„Åó„Åæ„Åó„Åü'); }
      })
      .catch(e => { this.showInfo('Error', e); this.isSaving = false; });
    },
    toggleTask(t) {
      const original = this.tasks.find(task => task.lineIndex === t.lineIndex);
      if (original) {
        original.completed = !original.completed;
        if (original.completed && original.recurrence) this.generateNextTask(original);
        this.pushChanges(true); 
      }
    },
    generateNextTask(t) {
        const d = new Date(t.due); const r = t.recurrence.toLowerCase();
        if (r.includes('day')) d.setDate(d.getDate()+1);
        else if (r.includes('week')) d.setDate(d.getDate()+7);
        else if (r.includes('month')) { const org=d.getDate(); d.setMonth(d.getMonth()+1); if(d.getDate()!==org) d.setDate(0); }
        else if (r.includes('year')) { const org=d.getDate(); d.setFullYear(d.getFullYear()+1); if(d.getDate()!==org) d.setDate(0); }
        if (!isNaN(d.getTime())) {
            this.tasks.push({ lineIndex: -1, desc: t.desc, due: this.getLocalYMD(d), recurrence: t.recurrence, priority: t.priority, created: this.getTodayStr(), completed: false, tags: [...t.tags] });
        }
    },
    async runArchiveProcess() {
      if (!this.settings.archivePath) { this.showInfo('Ë®≠ÂÆö„Ç®„É©„Éº', '„Ç¢„Éº„Ç´„Ç§„Éñ„Éë„Çπ„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì'); return; }
      if (!await this.confirmAction('„Ç¢„Éº„Ç´„Ç§„Éñ', 'ÂÆå‰∫Ü„Çø„Çπ„ÇØ„Çí„Ç¢„Éº„Ç´„Ç§„Éñ„Éï„Ç°„Ç§„É´„Å∏ÁßªÂãï„Åó„Åæ„Åô„ÅãÔºü')) return;
      this.loading = true; this.loadingMessage = '„Ç¢„Éº„Ç´„Ç§„Éñ‰∏≠...';
      try {
          const res = await this.fetchFileContent(this.settings.archivePath);
          const archiveContent = res.content || "";
          const completedLines = this.lines.filter(l => l.match(/^[-*]\s*\[x\]/i));
          const activeLines = this.lines.filter(l => !l.match(/^[-*]\s*\[x\]/i));
          if(completedLines.length === 0) { this.loading = false; this.showInfo('ÊÉÖÂ†±', 'ÂÆå‰∫Ü„Çø„Çπ„ÇØ„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì'); return; }
          const newArchive = archiveContent + (archiveContent ? "\n" : "") + completedLines.join("\n");
          await this.saveFileContentPromise(this.settings.archivePath, newArchive, res.sha);
          await this.saveFileContentPromise(this.settings.path, activeLines.join("\n"), this.sha);
          this.loading = false; this.showToastNotification('„Ç¢„Éº„Ç´„Ç§„ÉñÂÆå‰∫Ü'); this.loadData();
      } catch(e) { this.loading = false; this.showInfo('„Ç®„É©„Éº', e); }
    },
    handleTouchStart(e) { if (!e.target.closest('.calendar-wrapper')) { this.touchStartX = e.changedTouches[0].screenX; this.touchStartY = e.changedTouches[0].screenY; this.swipeIgnore = false; } else this.swipeIgnore = true; },
    handleTouchEnd(e) { if (this.swipeIgnore) return; this.touchEndX = e.changedTouches[0].screenX; const diffX = this.touchEndX - this.touchStartX; const diffY = e.changedTouches[0].screenY - this.touchStartY; if(Math.abs(diffX) > 100 && Math.abs(diffX) > Math.abs(diffY)*2) { if(diffX < 0) this.setTab(this.tabs[this.tabs.findIndex(t=>t.id==this.currentTab)+1]?.id||'active'); else this.setTab(this.tabs[this.tabs.findIndex(t=>t.id==this.currentTab)-1]?.id||'settings'); } },
    showModal(title, message, type='info', okText='OK', isDanger=false) { this.modal = { show: true, title, message, type, okText, isDanger, resolve: null }; return new Promise(resolve => { this.modal.resolve = resolve; }); },
    closeModal(result) { this.modal.show = false; if (this.modal.resolve) this.modal.resolve(result); },
    confirmAction(title, message, isDanger=false) { return this.showModal(title, message, 'confirm', isDanger ? 'ÂâäÈô§' : 'ÂÆüË°å', isDanger); },
    showInfo(title, message) { return this.showModal(title, message, 'info'); },
    async confirmRestore(task) { if(await this.confirmAction('Âæ©ÂÖÉ', 'Êú™ÂÆå‰∫Ü„Å´Êàª„Åó„Åæ„Åô„ÅãÔºü')) this.restoreTask(task); },
    restoreTask(task) { if(task.isArchived) this.restoreArchivedTask(task); else { const t=this.tasks.find(x=>x.lineIndex===task.lineIndex); if(t){t.completed=false; t.doneDate=''; this.pushChanges(true);} } },
    async confirmDelete(task) { if(await this.confirmAction('ÂâäÈô§', 'Êú¨ÂΩì„Å´ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü', true)) this.deleteTask(task); },
    deleteTask(task) { 
        if(task.isArchived) {
            if(!this.settings.archivePath) return;
            this.loading = true; this.loadingMessage = 'ÂâäÈô§‰∏≠...';
            this.fetchFileContent(this.settings.archivePath).then(res => {
                const lines = (res.content || '').split('\n');
                const newLines = lines.filter(l => l !== task.originalLine);
                this.saveFileContentPromise(this.settings.archivePath, newLines.join('\n'), res.sha)
                    .then(() => { this.loading = false; this.showToastNotification('ÂâäÈô§„Åó„Åæ„Åó„Åü'); this.loadArchiveData(); })
                    .catch(e => { this.loading = false; this.showInfo('Error', e); });
            });
        } 
        else { const idx=this.tasks.findIndex(t=>t.lineIndex===task.lineIndex); if(idx>-1){const org=this.tasks[idx]; this.tasks.splice(idx,1); if(org.lineIndex>=0){this.lines.splice(org.lineIndex,1); this.tasks.forEach(t=>{if(t.lineIndex>org.lineIndex)t.lineIndex--;}); this.pushChanges(); this.closePanel();}} } 
    },
    addTagFromHistory(tag) { if(!this.panelData.tags.includes(tag)) this.panelData.tags.push(tag); },
    removeTag(t) { this.panelData.tags = this.panelData.tags.filter(tg => tg !== t); },
    renderDesc(text) { return text ? text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" onclick="event.stopPropagation()">$1</a>') : ''; },
    changeDateRange(dir) { const d=new Date(this.currentCalStart); if(this.calendarMode==='week') d.setDate(d.getDate()+(dir*7)); else d.setMonth(d.getMonth()+dir); this.currentCalStart=d; },
    selectDate(date) { this.selectedDate = date; },
    loadMoreCompleted() { this.displayLimit += 50; },
    getPriorityColor(p) { return p==='high'?'#ef4444':p==='medium'?'#f59e0b':p==='low'?'#3b82f6':'#ccc'; },
    setDateShortcut(d) { const dt=new Date(); dt.setDate(dt.getDate()+d); this.panelData.due=this.getLocalYMD(dt); },
    showToastNotification(m) { this.toast.message=m; this.toast.show=true; setTimeout(()=>this.toast.show=false, 3000); },
    
    // --- Helper Functions ---
    getLocalYMD(d) { return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; },
    convertIsoToYMD(iso) { return iso ? this.getLocalYMD(new Date(iso)) : ''; },
    getTodayStr() { return this.getLocalYMD(new Date()); },
    formatTimeRange(item) { if(item.isAllDay) return 'ÁµÇÊó•'; const d1=new Date(item.start); const d2=new Date(item.end); return `${String(d1.getHours()).padStart(2,'0')}:${String(d1.getMinutes()).padStart(2,'0')} - ${String(d2.getHours()).padStart(2,'0')}:${String(d2.getMinutes()).padStart(2,'0')}`; },
    openEditPanel(item) {
      try {
          this.isEditMode=true; this.showPanel=true;
          if(item.isGCal) {
              const sd=new Date(item.start); const ed=new Date(item.end);
              let sh='', sm='', eh='', em='';
              if(!item.isAllDay) { sh=String(sd.getHours()).padStart(2,'0'); sm=String(sd.getMinutes()).padStart(2,'0'); eh=String(ed.getHours()).padStart(2,'0'); em=String(ed.getMinutes()).padStart(2,'0'); }
              
              // ‚òÖ URLÊäΩÂá∫„É≠„Ç∏„ÉÉ„ÇØ„ÅÆËøΩÂä† ‚òÖ
              let d = item.desc || '';
              let url = '';
              const urlMatch = d.match(/^„Äê‰ºöË≠∞URL„Äë:\s*(\S+)(\n\n)?/);
              if (urlMatch) {
                  url = urlMatch[1];
                  d = d.replace(urlMatch[0], ''); // „É°„É¢„Åã„ÇâURLÈÉ®ÂàÜ„ÇíÂâäÈô§„Åó„Å¶Ë°®Á§∫
              } else if (item.location && item.location.match(/^https?:\/\//)) {
                  url = item.location; // „É≠„Ç±„Éº„Ç∑„Éß„É≥„ÅåURL„Å™„Çâ„Åù„Çå„Çí‰Ωø„ÅÜ
              }

              this.panelData={
                  isGCal:true, isNew:false, eid:item.id, calendarId:item.calendarId, 
                  title:item.title, desc: d, meetingUrl: url,
                  dateInput:this.convertIsoToYMD(item.start), startHour:sh, startMin:sm, endHour:eh, endMin:em
              };
          } else {
              const org=this.tasks.find(t=>t.lineIndex===item.lineIndex)||item;
              // ‚òÖSafe handling for crash protection‚òÖ
              this.panelData={...org, taskRef:org, isGCal:false, tags:[...(org.tags || [])]};
              this.tagInput=''; 
              if(org.desc) {
                  const m=org.desc.match(/^\[([^\]]+)\]\(([^)]+)\)$/); 
                  if(m){this.panelData.desc=m[1]; this.panelData.url=m[2];}
              }
          }
      } catch(e) { console.error('Open Panel Error:', e); }
    }
  }
}).mount('#app');
</script>
</body>
</html>
