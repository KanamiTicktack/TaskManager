<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Tasks</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/vue@3.2.45/dist/vue.global.prod.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
  
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover, maximum-scale=1.0">
  <meta name="theme-color" content="#6366f1">
  <link rel="manifest" href="./manifest.json">
  <link rel="apple-touch-icon" href="./icon-192.png">
  
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js').catch(err => console.log(err));
    }
  </script>

  <style>
    /* === Design System === */
    :root {
      --primary: #6366f1; --primary-hover: #4f46e5; --danger: #ef4444;
      --bg-body: #f3f4f6; --bg-card: #ffffff; --bg-input: #ffffff;
      --text-main: #1f2937; --text-sub: #6b7280; --border-color: #e5e7eb;
      --hover-bg: #f9fafb; --shadow: 0 1px 3px rgba(0,0,0,0.05);
      --radius: 12px; --tag-bg: #e9ecef; --tag-text: #495057;
      --status-bg: #1f2937; --status-text: #ffffff;
      --time-slot-height: 50px;
    }
    body.dark-mode {
      --primary: #818cf8; --primary-hover: #6366f1;
      --bg-body: #111827; --bg-card: #1f2937; --bg-input: #374151;
      --text-main: #f3f4f6; --text-sub: #9ca3af; --border-color: #374151;
      --hover-bg: #374151; --shadow: 0 4px 6px rgba(0,0,0,0.3);
      --tag-bg: #374151; --tag-text: #d1d5db;
      --status-bg: #f3f4f6; --status-text: #1f2937;
    }
    body { background-color: var(--bg-body); color: var(--text-main); font-family: 'Inter', sans-serif; overflow-y: scroll; -webkit-tap-highlight-color: transparent; }
    .form-control, .form-select, input, textarea { background-color: var(--bg-input); border-color: var(--border-color); color: var(--text-main); font-size: 16px !important; }
    body.dark-mode ::-webkit-calendar-picker-indicator { filter: invert(1); }
    
    /* Layout */
    .app-container { 
        display: flex; flex-direction: column; gap: 16px; 
        max-width: 1600px; margin: 0 auto; padding: 16px; min-height: 100vh; position: relative;
    }
    
    /* PC Split View */
    @media (min-width: 992px) {
        .app-container { height: 100vh; overflow: hidden; padding-bottom: 0; }
        .app-header { flex-shrink: 0; }
        .main-content { flex: 1; min-height: 0; display: flex; flex-direction: column; }
        .split-layout { 
            display: grid; grid-template-columns: 1fr 1fr; gap: 24px; align-items: start;
            height: 100%; overflow: hidden;
        }
        .view-primary, .view-secondary { 
            display: block !important; height: 100%; overflow-y: auto; padding-bottom: 100px; padding-right: 4px;
            -ms-overflow-style: none; scrollbar-width: none; 
        }
        .view-primary::-webkit-scrollbar, .view-secondary::-webkit-scrollbar { display: none; }
    }

    .app-card { background: var(--bg-card); border-radius: var(--radius); box-shadow: var(--shadow); border: 1px solid var(--border-color); margin-bottom: 16px; overflow: hidden; }
    .app-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding: 0 4px; }
    .app-title { font-weight: 800; font-size: 1.5rem; margin: 0; color: var(--text-main); letter-spacing: -0.5px; }
    .btn-theme-toggle { background: transparent; border: none; color: var(--text-main); padding: 8px; }

    /* Tabs */
    .nav-tabs { border: none; gap: 8px; margin-bottom: 16px; flex-wrap: nowrap; overflow-x: auto; padding-bottom: 4px; }
    .nav-link { border: none; border-radius: 20px !important; color: var(--text-sub); font-weight: 600; padding: 8px 16px; cursor: pointer; white-space: nowrap; transition: 0.2s; font-size: 0.9rem; }
    .nav-link:hover { background: var(--hover-bg); color: var(--text-main); }
    .nav-link.active { background: var(--primary) !important; color: #fff !important; }
    
    /* Tasks */
    .task-card { 
        background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; margin-bottom: 8px; padding: 12px; 
        display: flex; gap: 12px; cursor: pointer; position: relative; overflow: hidden; transition: 0.1s; align-items: flex-start; 
    }
    .task-card:active { transform: scale(0.99); }
    .task-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; }
    .priority-high::before { background: #ef4444; } .priority-medium::before { background: #f59e0b; } .priority-low::before { background: #3b82f6; }
    
    .custom-checkbox { width: 22px; height: 22px; border: 2px solid var(--text-sub); border-radius: 6px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-top: 2px; }
    .custom-checkbox.checked { background: var(--primary); border-color: var(--primary); }
    .custom-checkbox .material-icons-round { font-size: 16px; color: white; opacity: 0; }
    .custom-checkbox.checked .material-icons-round { opacity: 1; }
    
    .task-content { flex: 1; min-width: 0; }
    .task-title { font-weight: 600; font-size: 0.95rem; margin-bottom: 4px; line-height: 1.4; }
    .task-meta { display: flex; gap: 6px; font-size: 0.75rem; color: var(--text-sub); flex-wrap: wrap; align-items: center; }
    
    .badge-base { padding: 2px 8px; border-radius: 6px; background: var(--hover-bg); border: 1px solid var(--border-color); display: flex; align-items: center; gap: 3px; }
    .tag-badge { background-color: var(--tag-bg); color: var(--tag-text); }
    .gcal-badge { background: #e0e7ff; color: #4338ca; border: none; }
    body.dark-mode .gcal-badge { background: #312e81; color: #e0e7ff; }
    
    .text-decoration-line-through { color: var(--text-sub); opacity: 0.7; }
    body.dark-mode .text-decoration-line-through { color: #9ca3af !important; }

    /* Timeline Calendar */
    .timeline-container { display: flex; flex-direction: column; height: 600px; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: var(--radius); overflow: hidden; margin-bottom: 16px; }
    .timeline-header { display: grid; grid-template-columns: 50px repeat(7, 1fr); border-bottom: 1px solid var(--border-color); background: var(--hover-bg); }
    .timeline-corner { border-right: 1px solid var(--border-color); }
    .timeline-day-header { padding: 8px 4px; text-align: center; border-right: 1px solid var(--border-color); font-size: 0.8rem; font-weight: bold; color: var(--text-sub); }
    .header-sun { color: #ef4444; } .header-sat { color: #3b82f6; }
    
    .allday-row { display: grid; grid-template-columns: 50px repeat(7, 1fr); border-bottom: 2px solid var(--border-color); min-height: 40px; }
    .allday-label { font-size: 0.7rem; color: var(--text-sub); display: flex; align-items: center; justify-content: center; border-right: 1px solid var(--border-color); background: var(--hover-bg); }
    .allday-cell { border-right: 1px solid var(--border-color); padding: 2px; position: relative; }
    .allday-item { font-size: 0.7rem; background: var(--primary); color: white; padding: 2px 4px; border-radius: 4px; margin-bottom: 2px; cursor: grab; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    
    .timeline-body { flex: 1; overflow-y: auto; display: grid; grid-template-columns: 50px repeat(7, 1fr); position: relative; }
    .time-labels { border-right: 1px solid var(--border-color); background: var(--hover-bg); }
    .time-label { height: var(--time-slot-height); border-bottom: 1px solid var(--border-color); font-size: 0.75rem; color: var(--text-sub); text-align: center; position: relative; top: -10px; }
    .day-column { border-right: 1px solid var(--border-color); position: relative; background: var(--bg-card); }
    .time-slot { height: var(--time-slot-height); border-bottom: 1px solid var(--border-color); box-sizing: border-box; }
    
    .event-chip { 
        position: absolute; left: 2px; right: 2px; background: var(--primary); color: white; border-radius: 4px; padding: 4px; font-size: 0.75rem; overflow: hidden; cursor: grab; z-index: 10; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    /* Month Grid */
    .calendar-wrapper { background: var(--bg-card); border-radius: var(--radius); border: 1px solid var(--border-color); margin-bottom: 16px; overflow: hidden; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, minmax(0, 1fr)); gap: 1px; background: var(--border-color); min-width: 300px; }
    .calendar-header-cell { padding: 8px 4px; text-align: center; font-size: 0.75rem; font-weight: 700; background: var(--hover-bg); color: var(--text-sub); }
    .calendar-cell { background: var(--bg-card); padding: 4px; min-height: 80px; cursor: pointer; display: flex; flex-direction: column; }
    .calendar-cell.selected { background: rgba(99, 102, 241, 0.1) !important; box-shadow: inset 0 0 0 2px var(--primary); }
    .date-num { align-self: center; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 600; border-radius: 50%; }
    .date-num.today { background: var(--primary); color: white; }
    .dot { width: 6px; height: 6px; border-radius: 50%; background: var(--text-sub); margin: 1px; }

    /* Side Panel & Modal */
    .side-panel { position: fixed; top: 0; right: 0; width: 100%; height: 100vh; background: var(--bg-card); z-index: 3000; display: flex; flex-direction: column; padding: 20px; overflow-y: auto; transition: transform 0.3s; transform: translateX(100%); box-shadow: -5px 0 25px rgba(0,0,0,0.2); }
    .side-panel.open { transform: translateX(0); }
    @media (min-width: 992px) { 
        .side-panel { top: 20px; right: 20px; width: 400px; height: calc(100vh - 40px); border-radius: 12px; border: 1px solid var(--border-color); z-index: 4000; opacity: 0; pointer-events: none; transition: opacity 0.2s; transform: none; }
        .side-panel.open { opacity: 1; pointer-events: auto; }
        .panel-header-mobile { display: none !important; } 
        .panel-header-pc { display: flex !important; }
    }
    .panel-header-mobile { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; }
    .panel-header-pc { display: none; align-items: center; justify-content: space-between; margin-bottom: 20px; }
    .btn-panel-back { background: transparent; border: none; padding: 8px; }
    .btn-close { background: transparent; border: none; font-size: 1.5rem; }

    /* Common Components */
    .fab-btn { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; border-radius: 20px; background: var(--primary); color: white; border: none; box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4); display: flex; justify-content: center; align-items: center; z-index: 2000; }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
    .modal-content { background: var(--bg-card); width: 90%; max-width: 400px; padding: 24px; border-radius: 16px; }
    .loading-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 9998; display: flex; align-items: center; justify-content: center; flex-direction: column; color: white; }
    .toast-notification { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #1f2937; color: white; padding: 12px 24px; border-radius: 50px; z-index: 3000; font-weight: 500; }
    
    /* Helper Classes */
    .date-shortcut-btn { font-size: 0.75rem; padding: 4px 10px; border-radius: 12px; border: 1px solid var(--border-color); background: var(--bg-input); color: var(--text-sub); margin-right: 4px; }
    .priority-select-btn { border: 1px solid var(--border-color); background: var(--bg-input); color: var(--text-sub); padding: 8px; flex: 1; border-radius: 8px; text-align: center; font-size: 0.85rem; cursor: pointer; }
    .priority-select-btn.active-high { background: rgba(239, 68, 68, 0.15); color: #ef4444; border-color: #ef4444; font-weight: bold; }
    .priority-select-btn.active-medium { background: rgba(245, 158, 11, 0.15); color: #f59e0b; border-color: #f59e0b; font-weight: bold; }
    .priority-select-btn.active-low { background: rgba(59, 130, 246, 0.15); color: #3b82f6; border-color: #3b82f6; font-weight: bold; }
    .priority-select-btn.active-none { background: var(--text-sub); color: white; border-color: var(--text-sub); }
    .tag-chip { font-size: 0.8rem; padding: 4px 10px; border-radius: 16px; background-color: var(--tag-bg); color: var(--tag-text); border: 1px solid var(--border-color); cursor: pointer; display: inline-block; margin-right: 4px; }
  </style>
</head>
<body>
<div id="app">
  <div v-if="loading" class="loading-overlay"><div class="spinner-border text-light"></div><div class="mt-3 fw-bold">{{ loadingMessage }}</div></div>
  <transition name="fade"><div v-if="toast.show" class="toast-notification">{{ toast.message }}</div></transition>

  <div v-if="modal.show" class="modal-overlay">
      <div class="modal-content">
          <div class="fw-bold mb-3 fs-5">{{ modal.title }}</div>
          <p class="text-secondary mb-4">{{ modal.message }}</p>
          <div class="d-flex justify-content-end gap-2">
              <button v-if="modal.type === 'confirm'" class="btn btn-light" @click="closeModal(false)">„Ç≠„É£„É≥„Çª„É´</button>
              <button class="btn" :class="modal.isDanger ? 'btn-danger' : 'btn-primary'" @click="closeModal(true)">{{ modal.okText }}</button>
          </div>
      </div>
  </div>

  <div class="app-container">
    <div class="app-header">
        <h1 class="app-title">Tasks</h1>
        <button class="btn-theme-toggle" @click="toggleDarkMode"><span class="material-icons-round">{{ darkMode ? 'light_mode' : 'dark_mode' }}</span></button>
    </div>

    <div class="main-content">
        <div class="split-layout">
            <div class="view-primary" v-show="!isPC && currentTab !== 'calendar' || isPC">
                <ul class="nav nav-tabs">
                    <li class="nav-item"><a class="nav-link" :class="{active: currentTab === 'active'}" @click.prevent="setTab('active')" href="#">Êú™ÂÆå‰∫Ü <span v-if="activeCount" class="badge bg-secondary rounded-pill ms-1">{{ activeCount }}</span></a></li>
                    <li class="nav-item"><a class="nav-link" :class="{active: currentTab === 'completed'}" @click.prevent="setTab('completed')" href="#">ÂÆå‰∫ÜÊ∏à</a></li>
                    <li class="nav-item" v-if="!isPC"><a class="nav-link" :class="{active: currentTab === 'calendar'}" @click.prevent="setTab('calendar')" href="#">„Ç´„É¨„É≥„ÉÄ„Éº</a></li>
                    <li class="nav-item"><a class="nav-link" :class="{active: currentTab === 'settings'}" @click.prevent="setTab('settings')" href="#">Ë®≠ÂÆö</a></li>
                </ul>

                <div v-if="currentTab !== 'settings'" class="d-flex justify-content-end mb-3">
                    <select class="form-select form-select-sm" v-model="filterTag" style="width: auto; max-width: 200px; border-radius: 20px;">
                        <option value="">üè∑Ô∏è „Åô„Åπ„Å¶„ÅÆ„Çø„Ç∞</option>
                        <option v-for="tag in allTagsList" :key="tag" :value="tag">#{{ tag.replace(/^#/, '') }}</option>
                    </select>
                </div>

                <div v-if="currentTab === 'settings'" class="app-card p-4">
                    <h5 class="fw-bold mb-4">Ë®≠ÂÆö</h5>
                    <input type="password" v-model="settings.token" class="form-control mb-2" placeholder="GitHub Token">
                    <div class="row g-2 mb-2"><div class="col"><input v-model="settings.owner" class="form-control" placeholder="Owner"></div><div class="col"><input v-model="settings.repo" class="form-control" placeholder="Repo"></div></div>
                    <input v-model="settings.path" class="form-control mb-2" placeholder="Path (e.g. Tasks.md)">
                    <button class="btn btn-primary w-100 mb-3" @click="saveSettings">Ë®≠ÂÆö„Çí‰øùÂ≠ò</button>
                    <div v-for="cal in availableCalendars" :key="cal.id" class="form-check"><input class="form-check-input" type="checkbox" :value="cal.id" v-model="settings.calendarIds"><label class="form-check-label">{{ cal.name }}</label></div>
                </div>

                <div v-else-if="currentTab === 'active'">
                    <div v-for="group in groupedActiveTasks" :key="group.title" class="mb-4">
                        <h6 class="fw-bold text-secondary small mb-2 ms-1">{{ group.title }}</h6>
                        <div v-for="task in group.tasks" :key="task.lineIndex" class="task-card" :class="'priority-'+task.priority" @click="openEditPanel(task)">
                            <div class="custom-checkbox" @click.stop="toggleTask(task)"><span class="material-icons-round">check</span></div>
                            <div class="task-content">
                                <div class="task-title" v-html="renderDesc(task.desc)"></div>
                                <div class="task-meta">
                                    <span v-for="tag in task.tags" class="badge-base tag-badge">#{{ tag.replace(/^#/, '') }}</span>
                                    <span v-if="task.due" class="badge-base"><span class="material-icons-round" style="font-size:12px">event</span> {{ task.due }}</span>
                                    <span v-if="task.recurrence" class="badge-base">üîÅ {{ task.recurrence }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-else-if="currentTab === 'completed'">
                    <div v-if="displayCompletedTasks.length === 0" class="text-center py-5 text-muted"><p>ÂÆå‰∫ÜÊ∏à„Åø„Çø„Çπ„ÇØ„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</p></div>
                    <div v-for="task in displayCompletedTasks" :key="task.uniqueId" class="task-card opacity-75">
                        <div class="custom-checkbox checked" @click.stop="confirmRestore(task)"><span class="material-icons-round">check</span></div>
                        <div class="task-content text-decoration-line-through">
                            <div class="task-title" v-html="renderDesc(task.desc)"></div>
                            <div class="task-meta">
                                <span v-if="task.isArchived" class="badge bg-secondary text-white" style="font-size:0.6rem">Archived</span>
                                <span v-for="tag in task.tags" class="badge-base tag-badge">#{{ tag.replace(/^#/, '') }}</span>
                                Done: {{ task.doneDate }}
                            </div>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn-restore" @click.stop="confirmRestore(task)"><span class="material-icons-round" style="font-size:16px">undo</span></button>
                            <button class="btn-delete" @click.stop="confirmDelete(task)"><span class="material-icons-round" style="font-size:20px">delete</span></button>
                        </div>
                    </div>
                    <div v-if="displayCompletedTasks.length < allCompletedTasks.length" class="text-center mt-3"><button class="btn btn-sm btn-outline-secondary" @click="loadMoreCompleted">„ÇÇ„Å£„Å®Ë¶ã„Çã</button></div>
                </div>
            </div>

            <div class="view-secondary" v-show="isPC || currentTab === 'calendar'">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="btn-group shadow-sm">
                        <button class="btn btn-sm btn-light border" :class="{active: calendarMode==='week'}" @click="calendarMode='week'">ÈÄ±</button>
                        <button class="btn btn-sm btn-light border" :class="{active: calendarMode==='month'}" @click="calendarMode='month'">Êúà</button>
                    </div>
                    <div class="d-flex align-items-center gap-2 bg-white rounded shadow-sm px-2 py-1 border" style="background-color: var(--bg-card) !important; border-color: var(--border-color) !important;">
                        <button class="btn btn-sm btn-light" @click="changeDateRange(-1)">‚óÄ</button><span class="fw-bold small px-2">{{ calendarTitle }}</span><button class="btn btn-sm btn-light" @click="changeDateRange(1)">‚ñ∂</button>
                    </div>
                </div>

                <div v-if="calendarMode === 'week'" class="timeline-container">
                    <div class="allday-row">
                        <div class="allday-label">ÁµÇÊó•</div>
                        <div v-for="day in calendarDays" :key="'ad-'+day.date" class="allday-cell" @dragover.prevent @drop="onDrop($event, day.date, null)">
                            <div v-for="item in day.items.filter(i=>i.isGCal && i.isAllDay)" class="allday-item" :style="{background: item.color}" draggable="true" @dragstart="dragStart($event, item)" @click.stop="openEditPanel(item)">
                                {{ item.title }}
                            </div>
                        </div>
                    </div>
                    <div class="timeline-header">
                        <div class="timeline-corner"></div>
                        <div v-for="day in calendarDays" :key="'h-'+day.date" class="timeline-day-header" :class="{'header-sun':day.dayOfWeek==0,'header-sat':day.dayOfWeek==6}">
                            <div>{{ ['Êó•','Êúà','ÁÅ´','Ê∞¥','Êú®','Èáë','Âúü'][day.dayOfWeek] }}</div>
                            <div style="font-size:1.1rem">{{ day.dayNum }}</div>
                        </div>
                    </div>
                    <div class="timeline-body">
                        <div class="time-labels"><div v-for="h in timelineHours" :key="h" class="time-label">{{ h }}:00</div></div>
                        <div v-for="day in calendarDays" :key="'b-'+day.date" class="day-column" @dragover.prevent @drop="onDrop($event, day.date)">
                             <div v-for="h in timelineHours" :key="'slot-'+h" class="time-slot" @drop.stop="onDrop($event, day.date, h)"></div>
                             <div v-for="item in day.items.filter(i=>!i.isAllDay && i.isGCal && getEventStyle(i))" class="event-chip" :style="getEventStyle(item)" draggable="true" @dragstart="dragStart($event, item)" @click.stop="openEditPanel(item)">
                                 {{ item.title }}
                             </div>
                        </div>
                    </div>
                </div>

                <div v-else class="calendar-wrapper">
                    <div class="calendar-grid">
                        <div v-for="d in ['Êó•','Êúà','ÁÅ´','Ê∞¥','Êú®','Èáë','Âúü']" class="calendar-header-cell" :class="{'header-sun':d=='Êó•','header-sat':d=='Âúü'}">{{ d }}</div>
                        <div v-for="(day, idx) in calendarDays" :key="idx" class="calendar-cell" :class="[{'selected': day.date === selectedDate}]" @click="selectDate(day.date)">
                            <div class="date-num" :class="{today: day.isToday}">{{ day.dayNum }}</div>
                            <div class="dot-container"><div v-for="item in day.items" class="dot" :style="item.isGCal ? {background: item.color} : {background: 'var(--text-sub)'}"></div></div>
                        </div>
                    </div>
                </div>

                <div class="app-card p-0" v-if="selectedDate">
                    <div class="p-3 border-bottom d-flex justify-content-between align-items-center" style="background-color: var(--hover-bg);"><h6 class="m-0 fw-bold">{{ selectedDateDisplay }}</h6><div class="d-flex gap-2"><button class="btn btn-sm btn-outline-primary" @click="openAddGCalPanel(selectedDate)">+ ‰∫àÂÆö</button><button class="btn btn-sm btn-primary" @click="openAddPanelWithDate(selectedDate)">+ „Çø„Çπ„ÇØ</button></div></div>
                    <div class="p-2">
                        <div v-if="selectedDateItems.length === 0" class="text-center py-4 text-muted small">‰∫àÂÆö„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>
                        <div v-for="item in selectedDateItems" :key="item.uniqueId" class="task-card border-0 mb-1" :style="item.isGCal ? {background: 'var(--hover-bg)'} : {}" @click="openEditPanel(item)">
                            <div v-if="item.isGCal" class="me-2"><span class="material-icons-round" :style="{color: item.color}">event</span></div>
                            <div v-else class="custom-checkbox me-2" :class="{checked: item.completed}" @click.stop="toggleTask(item)"><span class="material-icons-round">check</span></div>
                            <div class="task-content">
                                <div class="task-title" :class="{'text-decoration-line-through text-muted': item.completed}" v-html="renderDesc(item.isGCal ? item.title : item.desc)"></div>
                                <div class="task-meta">
                                    <span v-if="item.isGCal" class="badge-base" :style="{background: item.color, color:'white'}">{{ item.calendarName }}</span>
                                    <span v-if="item.isGCal">{{ item.isAllDay ? 'ÁµÇÊó•' : item.timeStr }}</span>
                                    <span v-if="!item.isGCal && item.priority!='none'" class="fw-bold" :style="{color: getPriorityColor(item.priority)}">Prior: {{ item.priority }}</span>
                                    <span v-if="!item.isGCal" v-for="tag in item.tags" class="badge-base tag-badge">#{{ tag.replace(/^#/, '') }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="side-panel" :class="{open: showPanel}">
        <div class="panel-header-mobile">
            <button class="btn-panel-back" @click="closePanel"><span class="material-icons-round">arrow_back</span></button>
            <h5 class="fw-bold m-0 flex-grow-1">{{ isEditMode ? 'Á∑®ÈõÜ' : 'Êñ∞Ë¶è‰ΩúÊàê' }}</h5>
            <button class="btn-close" @click="closePanel">√ó</button>
        </div>
        <div class="panel-header-pc">
            <h5 class="fw-bold m-0">{{ isEditMode ? 'Á∑®ÈõÜ' : 'Êñ∞Ë¶è‰ΩúÊàê' }}</h5>
            <button class="btn-close" @click="closePanel">√ó</button>
        </div>
        
        <div v-if="panelData.isGCal" class="d-flex flex-column h-100">
            <div class="mb-3" v-if="panelData.isNew"><label class="small fw-bold text-secondary">„Ç´„É¨„É≥„ÉÄ„Éº</label><select class="form-select" v-model="panelData.targetCalendarId"><option v-for="cal in availableCalendars" :value="cal.id">{{ cal.name }}</option></select></div>
            <input type="text" v-model="panelData.title" class="form-control fw-bold fs-5 mb-3" placeholder="„Çø„Ç§„Éà„É´">
            <div class="mb-3"><label class="small fw-bold text-secondary mb-1">Êó•‰ªò</label><input type="date" v-model="panelData.dateInput" class="form-control text-center" style="font-size: 1.1rem;"></div>
            <div class="row g-2 mb-3">
                <div class="col-6"><label class="small fw-bold text-secondary mb-1">ÈñãÂßã</label><div class="d-flex gap-1"><select v-model="panelData.startHour" class="form-select"><option v-for="h in hours" :value="h">{{h}}</option></select>:<select v-model="panelData.startMin" class="form-select"><option v-for="m in minutes" :value="m">{{m}}</option></select></div></div>
                <div class="col-6"><label class="small fw-bold text-secondary mb-1">ÁµÇ‰∫Ü</label><div class="d-flex gap-1"><select v-model="panelData.endHour" class="form-select"><option value="">--</option><option v-for="h in hours" :value="h">{{h}}</option></select>:<select v-model="panelData.endMin" class="form-select"><option value="">--</option><option v-for="m in minutes" :value="m">{{m}}</option></select></div></div>
            </div>
            <div class="mb-3"><label class="small fw-bold text-secondary mb-1">‰ºöË≠∞URL</label><input type="url" v-model="panelData.meetingUrl" class="form-control" placeholder="https://..."></div>
            <textarea v-model="panelData.desc" class="form-control flex-grow-1" placeholder="„É°„É¢"></textarea>
            <div class="mt-3 d-flex gap-2"><button class="btn btn-outline-secondary flex-grow-1" @click="closePanel">„Ç≠„É£„É≥„Çª„É´</button><button class="btn btn-primary flex-grow-1" @click="saveGCalEvent">‰øùÂ≠ò</button></div>
        </div>

        <div v-else class="d-flex flex-column h-100">
            <label class="small fw-bold text-secondary mb-1">„Çø„Çπ„ÇØÂêç</label>
            <textarea v-model="panelData.desc" class="form-control fw-bold fs-6 mb-4" rows="3" placeholder="‰Ωï„Çí„Åô„ÇãÔºü"></textarea>
            <div class="row g-4 mb-4">
                <div class="col-12 col-sm-6 border-end-sm">
                    <label class="small fw-bold text-secondary mb-2">„Çπ„Ç±„Ç∏„É•„Éº„É´</label>
                    <input type="date" v-model="panelData.due" class="form-control form-control-sm mb-2">
                    <div class="d-flex gap-1 mb-3"><button class="date-shortcut-btn" @click="setDateShortcut(0)">‰ªäÊó•</button><button class="date-shortcut-btn" @click="setDateShortcut(1)">ÊòéÊó•</button></div>
                    <label class="small fw-bold text-secondary mb-1">Áπ∞„ÇäËøî„Åó</label>
                    <input type="text" v-model="panelData.recurrence" class="form-control form-control-sm" placeholder="every week" list="recurrenceOptions">
                </div>
                <div class="col-12 col-sm-6">
                    <label class="small fw-bold text-secondary mb-2">ÂÑ™ÂÖàÂ∫¶</label>
                    <div class="d-flex flex-column gap-2 mb-3">
                        <div class="btn-group w-100" role="group">
                            <button class="priority-select-btn" :class="{'active-high': panelData.priority==='high'}" @click="panelData.priority='high'">È´ò</button>
                            <button class="priority-select-btn" :class="{'active-medium': panelData.priority==='medium'}" @click="panelData.priority='medium'">‰∏≠</button>
                            <button class="priority-select-btn" :class="{'active-low': panelData.priority==='low'}" @click="panelData.priority='low'">‰Ωé</button>
                        </div>
                        <button class="priority-select-btn active-none" v-if="panelData.priority==='none'" @click="panelData.priority='medium'">„Å™„Åó</button>
                        <button class="priority-select-btn" v-else @click="panelData.priority='none'">„ÇØ„É™„Ç¢</button>
                    </div>
                    <label class="small fw-bold text-secondary mb-1">„Çø„Ç∞</label>
                    <div class="input-group input-group-sm mb-2"><span class="input-group-text bg-transparent border-end-0">#</span><input type="text" class="form-control border-start-0 ps-0" v-model="tagInput" @keydown.enter.prevent="addTag" placeholder="New"><button class="btn btn-outline-secondary" @click="addTag">+</button></div>
                    <div class="d-flex flex-wrap gap-1 mb-2"><span v-for="tag in panelData.tags" :key="tag" class="badge bg-primary d-flex align-items-center gap-1" style="cursor:pointer" @click="removeTag(tag)">{{ tag.replace(/^#/, '') }} <span class="material-icons-round" style="font-size:10px">close</span></span></div>
                </div>
            </div>
            <div class="mb-3">
                <label class="small fw-bold text-secondary mb-1">„Çà„Åè‰Ωø„ÅÜ„Çø„Ç∞ (History)</label>
                <div class="d-flex flex-wrap gap-1 p-2 border rounded" style="background: var(--bg-input); min-height: 40px; border-color: var(--border-color) !important;">
                    <span v-for="tag in suggestedTags" :key="tag" class="tag-chip" @click="addTagFromHistory(tag)">#{{ tag.replace(/^#/, '') }}</span>
                </div>
            </div>
            <div class="mt-auto"><label class="small fw-bold text-secondary mb-1">URL (‰ªªÊÑè)</label><input type="url" v-model="panelData.url" class="form-control form-control-sm mb-3 text-muted" placeholder="https://...">
                <div class="d-flex gap-2">
                    <button class="btn btn-delete" v-if="isEditMode" @click="confirmDelete(panelData.taskRef)"><span class="material-icons-round">delete</span></button>
                    <button class="btn btn-outline-secondary flex-grow-1" @click="closePanel">„Ç≠„É£„É≥„Çª„É´</button>
                    <button class="btn btn-primary flex-grow-1" @click="saveTaskChanges">‰øùÂ≠ò</button>
                </div>
            </div>
        </div>
    </div>

    <button v-if="!showPanel && (!isPC || currentTab === 'active' || currentTab === 'calendar')" class="fab-btn" @click="openAddPanel"><span class="material-icons-round">add</span></button>
    <datalist id="recurrenceOptions"><option value="every day"></option><option value="every week"></option></datalist>
</div>

<script>
const CONST_GAS_URL = "https://script.google.com/macros/s/AKfycbxd-vue3AV2zTLZ5abQVw287UD6fVXj44E0_9kzBW6P5EILSTua0q3EBKLd9MzSd6HNjw/exec"; 

async function callGAS(action, params = {}) {
  const response = await fetch(CONST_GAS_URL, { method: 'POST', body: JSON.stringify({ ...params, action }) });
  const json = await response.json(); if (json.error) throw new Error(json.error); return json;
}

const { createApp } = Vue;
createApp({
  data() {
    return {
      loading: false, loadingMessage: 'Loading...', isSaving: false,
      currentTab: 'active', isPC: window.innerWidth >= 992,
      settings: { token: '', owner: '', repo: '', path: '', archivePath: '', calendarIds: [] },
      hasSettingsChanged: false, darkMode: false,
      lines: [], tasks: [], archiveTasks: [],
      calendarMode: 'week', selectedDate: '', currentCalStart: new Date(), gcalEvents: [], availableCalendars: [],
      showPanel: false, isEditMode: false,
      panelData: { desc:'', due:'', startHour:'09', startMin:'00', endHour:'', endMin:'', meetingUrl:'' },
      tagInput: '', allTagsList: [], filterTag: '',
      modal: { show: false, title: '', message: '', type: 'info', okText: 'OK', resolve: null },
      toast: { show: false, message: '' },
      timelineHours: [9,10,11,12,13,14,15,16,17,18,19,20],
      hours: Array.from({length:24}, (_,i)=>String(i).padStart(2,'0')), minutes: ['00', '15', '30', '45']
    }
  },
  computed: {
    activeCount() { return this.tasks.filter(t => !t.completed).length; },
    groupedActiveTasks() {
        const today = this.getTodayStr();
        const todayGroup = { title: '‰ªäÊó• & ÊúüÈôêÂàá„Çå', tasks: [] };
        const noDateGroup = { title: 'ÊúüÈôê„Å™„Åó', tasks: [] };
        const futureGroups = {};
        const filteredTasks = this.tasks.filter(t => !t.completed && (!this.filterTag || t.tags.includes(this.filterTag)));
        filteredTasks.forEach(task => {
            if (!task.due) noDateGroup.tasks.push(task);
            else if (task.due <= today) todayGroup.tasks.push(task);
            else { if (!futureGroups[task.due]) futureGroups[task.due] = []; futureGroups[task.due].push(task); }
        });
        const result = [];
        if (todayGroup.tasks.length > 0) result.push(todayGroup);
        Object.keys(futureGroups).sort().forEach(date => result.push({ title: date, tasks: futureGroups[date] }));
        if (noDateGroup.tasks.length > 0) result.push(noDateGroup);
        return result;
    },
    displayCompletedTasks() { return this.allCompletedTasks.slice(0, this.displayLimit); },
    allCompletedTasks() {
      const main = this.tasks.filter(t => t.completed && (!this.filterTag || t.tags.includes(this.filterTag))).map(t => ({...t, isArchived: false, uniqueId: 'm-'+t.lineIndex}));
      const arch = this.archiveTasks.filter(t => !this.filterTag || t.tags.includes(this.filterTag)).map((t,i) => ({...t, isArchived: true, uniqueId: 'a-'+i}));
      main.sort((a, b) => (a.doneDate < b.doneDate ? 1 : -1));
      arch.sort((a, b) => (a.doneDate < b.doneDate ? 1 : -1));
      return [...main, ...arch];
    },
    selectedDateItems() {
      if (!this.selectedDate) return [];
      const dateStr = this.selectedDate;
      const dayTasks = this.tasks.filter(t => t.due === dateStr && (!this.filterTag || t.tags.includes(this.filterTag)))
                                 .map(t => ({...t, isGCal: false, uniqueId: 'task-'+t.lineIndex}));
      const dayGcals = this.gcalEvents.filter(e => this.convertIsoToYMD(e.start) === dateStr)
                                    .map(e => ({...e, isGCal: true, uniqueId: 'gcal-'+e.id, desc: e.desc, title: e.title, timeStr: this.formatTimeRange(e)}));
      return [...dayGcals, ...dayTasks].sort((a, b) => {
          if (a.isGCal && !b.isGCal) return -1; 
          if (!a.isGCal && b.isGCal) return 1;
          const tA = a.isGCal ? (a.isAllDay ? '00:00' : a.start) : (a.due + 'T00:00');
          const tB = b.isGCal ? (b.isAllDay ? '00:00' : b.start) : (b.due + 'T00:00');
          return tA > tB ? 1 : -1;
      });
    },
    calendarTitle() { const d=new Date(this.currentCalStart); return `${d.getFullYear()}/${d.getMonth()+1}`; },
    calendarDays() {
        const days = []; const d = new Date(this.currentCalStart);
        let start = new Date(d); 
        if (this.calendarMode==='week') start.setDate(d.getDate() - d.getDay()); 
        else { start.setDate(1); start.setDate(start.getDate() - start.getDay()); }
        const count = this.calendarMode==='week' ? 7 : 42;
        for(let i=0; i<count; i++) {
            const date = new Date(start); date.setDate(startDate.getDate() + i);
            const dateStr = this.getLocalYMD(date);
            const dayEvents = this.gcalEvents.filter(e => this.convertIsoToYMD(e.start) === dateStr);
            const dayTasks = this.tasks.filter(t => t.due === dateStr);
            // ‚òÖ Ver 8.0: Timeline only shows GCal events, but Task count is visible in Dot container logic
            const items = [...dayTasks.map(t=>({...t, isGCal:false})), ...dayEvents.map(e=>({...e, isGCal:true}))];
            days.push({ date: dateStr, dayNum: date.getDate(), dayOfWeek: date.getDay(), isToday: dateStr === this.getTodayStr(), items });
        }
        return days;
    }
  },
  mounted() {
    this.selectedDate = this.getTodayStr();
    window.addEventListener('resize', this.handleResize);
    const saved = localStorage.getItem('gh_tasks_settings');
    if(localStorage.getItem('obsidian_tasks_theme')==='dark') { this.darkMode=true; document.body.classList.add('dark-mode'); }
    if (saved) { this.settings = JSON.parse(saved); this.loadData(); } else { this.currentTab = 'settings'; }
  },
  beforeUnmount() { window.removeEventListener('resize', this.handleResize); },
  methods: {
    handleResize() { this.isPC = window.innerWidth >= 992; if(this.isPC && this.currentTab === 'calendar') this.currentTab = 'active'; },
    setTab(id) { 
        this.currentTab = id; 
        // ‚òÖ Restore Archive Loading Logic ‚òÖ
        if (id === 'completed' && this.archiveTasks.length === 0 && this.settings.archivePath) {
            this.loadArchiveData();
        }
    },
    toggleDarkMode() { this.darkMode=!this.darkMode; document.body.classList.toggle('dark-mode'); localStorage.setItem('obsidian_tasks_theme', this.darkMode?'dark':'light'); },
    addTag() { let v=this.tagInput.trim(); if(!v)return; if(!v.startsWith('#'))v='#'+v; if(!this.panelData.tags.includes(v))this.panelData.tags.push(v); this.tagInput=''; },
    parseContent(text) {
        this.lines = text.split('\n'); this.tasks=[]; const foundTags=new Set();
        this.lines.forEach((line, i) => {
            const m = line.match(/^[-*]\s*\[([xX ])\]\s*(.*)/);
            if(m) {
                let body = m[2]; const completed = m[1].toLowerCase() === 'x';
                const due = (body.match(/üìÖ\s*(\d{4}-\d{2}-\d{2})/) || [])[1] || '';
                const created = (body.match(/‚ûï\s*(\d{4}-\d{2}-\d{2})/) || [])[1] || '';
                const recurrence = (body.match(/üîÅ\s*([^‚úÖ‚ûïüìÖ#\n\r]+)/) || [])[1] ? (body.match(/üîÅ\s*([^‚úÖ‚ûïüìÖ#\n\r]+)/) || [])[1].trim() : '';
                let priority = 'none'; if(body.includes('‚è´')) priority='high'; else if(body.includes('üîº')) priority='medium'; else if(body.includes('üîΩ')) priority='low';
                const tags = [];
                let tempBody = body.replace(/\[.*?\]\(.*?\)/g, '').replace(/https?:\/\/\S+/g, '');
                (tempBody.match(/#[^\s#]+/g) || []).forEach(t => {
                    let tag = t.replace(/[.,!?:;)}\]]+$/, '');
                    if(tag.toLowerCase() !== '#todo' && !tag.includes('=') && tag.length > 1) { tags.push(tag); foundTags.add(tag); }
                });
                let desc = body.replace(/üìÖ\s*\d{4}-\d{2}-\d{2}|‚úÖ\s*\d{4}-\d{2}-\d{2}|üîÅ\s*[^‚úÖ‚ûïüìÖ#\n\r]+|‚ûï\s*\d{4}-\d{2}-\d{2}|‚è´|üîº|üîΩ/g, '');
                tags.forEach(t => desc = desc.replace(new RegExp(`(^|\\s)${t.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}(?=\\s|$)`, 'g'), ' '));
                desc = desc.replace(/#todo/gi, '').trim();
                this.tasks.push({ lineIndex: i, originalLine: line, desc, due, recurrence, priority, created, completed, tags });
            }
        });
        this.allTagsList = Array.from(foundTags).sort();
    },
    // Actions
    openAddPanel() { if(this.currentTab === 'calendar' || this.isPC) this.openAddGCalPanel(this.getTodayStr()); else this.openAddPanelWithDate(this.getTodayStr()); },
    openAddPanelWithDate(d) { try{ this.isEditMode=false; this.showPanel=true; this.panelData={desc:'', due:d, isGCal:false, tags:[], priority:'none'}; this.tagInput=''; }catch(e){console.error(e);} },
    openAddGCalPanel(d) { try{ this.isEditMode=false; this.showPanel=true; const now=new Date(); this.panelData={isGCal:true, isNew:true, dateInput:d, startHour:String(now.getHours()).padStart(2,'0'), startMin:'00', endHour:'', endMin:'', meetingUrl:'', desc:'', targetCalendarId:this.settings.calendarIds[0]||''}; }catch(e){console.error(e);} },
    openEditPanel(item) {
      try {
          this.isEditMode=true; this.showPanel=true;
          if(item.isGCal) {
              const s=new Date(item.start); const e=new Date(item.end);
              let desc = item.desc || ''; let url = '';
              const m = desc.match(/^„Äê‰ºöË≠∞URL„Äë:\s*(\S+)(\n\n)?/);
              if(m) { url=m[1]; desc=desc.replace(m[0],''); } else if(item.location && item.location.match(/^https?:\/\//)) url=item.location;
              this.panelData={isGCal:true, isNew:false, eid:item.id, calendarId:item.calendarId, title:item.title, desc:desc, meetingUrl:url, dateInput:this.convertIsoToYMD(item.start), startHour:String(s.getHours()).padStart(2,'0'), startMin:String(s.getMinutes()).padStart(2,'0'), endHour:String(e.getHours()).padStart(2,'0'), endMin:String(e.getMinutes()).padStart(2,'0')};
          } else {
              const org=this.tasks.find(t=>t.lineIndex===item.lineIndex)||item;
              this.panelData={...org, taskRef:org, isGCal:false, tags:[...(org.tags||[])]}; this.tagInput=''; 
              if(org.desc) { const m=org.desc.match(/^\[([^\]]+)\]\(([^)]+)\)$/); if(m){this.panelData.desc=m[1]; this.panelData.url=m[2];} }
          }
      } catch(e) { console.error(e); }
    },
    // Data Ops
    async loadData() { this.loading=true; try{ const res=await callGAS('getFileContent', this.settings); this.rawContent=res.content; this.sha=res.sha; this.parseContent(res.content); await this.fetchGCal(); this.availableCalendars=await callGAS('getAvailableCalendars'); }catch(e){console.error(e);}finally{this.loading=false;} },
    async fetchGCal() { if(!this.settings.calendarIds.length)return; const res=await callGAS('getCalendarEvents', {startStr:this.calendarDays[0].date, endStr:this.calendarDays[this.calendarDays.length-1].date, calendarIds:JSON.stringify(this.settings.calendarIds)}); if(res.events)this.gcalEvents=res.events; },
    async saveGCalEvent() {
      this.isSaving=true;
      let d=this.panelData.desc||''; if(this.panelData.meetingUrl) d="„Äê‰ºöË≠∞URL„Äë: "+this.panelData.meetingUrl+"\n\n"+d;
      try {
          await callGAS(this.panelData.isNew?'createCalendarEvent':'updateCalendarEvent', {...this.panelData, description:d, desc:d, startTime:this.panelData.startHour+':'+this.panelData.startMin, endTime:this.panelData.endHour?this.panelData.endHour+':'+this.panelData.endMin:null, dateStr:this.panelData.dateInput});
          this.showPanel=false; this.fetchGCal();
      } catch(e){this.showInfo('Error',e);} finally{this.isSaving=false;}
    },
    async saveTaskChanges() {
        let d=this.panelData.desc; if(this.panelData.url) d=`[${d}](${this.panelData.url})`;
        if(this.isEditMode) { const t=this.panelData.taskRef; t.desc=d; t.due=this.panelData.due; t.priority=this.panelData.priority; t.recurrence=this.panelData.recurrence; t.tags=[...this.panelData.tags]; }
        else { this.tasks.push({lineIndex:-1, desc:d, due:this.panelData.due, priority:this.panelData.priority, recurrence:this.panelData.recurrence, created:this.getTodayStr(), completed:false, tags:[...this.panelData.tags]}); }
        this.showPanel=false; this.pushChanges();
    },
    pushChanges() {
        this.isSaving=true;
        const newLines=[...this.lines];
        this.tasks.forEach(t=>{
            const cb=t.completed?'- [x]':'- [ ]'; const cr=t.created?` ‚ûï ${t.created}`:''; const du=t.due?` üìÖ ${t.due}`:''; const re=t.recurrence?` üîÅ ${t.recurrence}`:'';
            let pr=''; if(t.priority==='high')pr=' ‚è´'; else if(t.priority==='medium')pr=' üîº'; else if(t.priority==='low')pr=' üîΩ';
            let do_=''; if(t.doneDate)do_=` ‚úÖ ${t.doneDate}`; else if(t.completed)do_=` ‚úÖ ${this.getTodayStr()}`;
            const tags=t.tags.length>0?' '+t.tags.join(' '):''; const tagStr=tags.includes('#todo')?tags:` #todo${tags}`;
            const line=`${cb} ${t.desc}${pr}${re}${do_}${tagStr}${cr}${du}`.replace(/\s+/g,' ');
            if(t.lineIndex>=0)newLines[t.lineIndex]=line; else{newLines.push(line); t.lineIndex=newLines.length-1;}
        });
        callGAS('saveFileContent', {...this.settings, content:newLines.join('\n'), sha:this.sha}).then(res=>{this.sha=res.newSha; this.lines=newLines; this.showToastNotification('‰øùÂ≠ò„Åó„Åæ„Åó„Åü');}).catch(e=>this.showInfo('Error',e)).finally(()=>this.isSaving=false);
    },
    // D&D
    dragStart(e, item) { if(!item.isGCal && !item.isAllDay) return; e.dataTransfer.setData('text/plain', JSON.stringify(item)); e.dataTransfer.effectAllowed='move'; },
    onDrop(e, dateStr, hour) {
        const item = JSON.parse(e.dataTransfer.getData('text/plain'));
        let start, end;
        if(item.isGCal && !item.isAllDay && hour) {
            start = `${dateStr}T${String(hour).padStart(2,'0')}:00:00`;
            end = new Date(new Date(start).getTime() + (new Date(item.end)-new Date(item.start))).toISOString();
        } else {
            const timeP = item.isAllDay?'':('T'+item.start.split('T')[1]);
            start = dateStr + timeP;
            end = item.isAllDay?dateStr:(dateStr+('T'+item.end.split('T')[1]));
        }
        this.loading=true;
        callGAS('updateCalendarEvent', {calendarId:item.calendarId, eventId:item.id, dateStr:dateStr, startTime:item.isAllDay?null:start.split('T')[1].substring(0,5), endTime:item.isAllDay?null:end.split('T')[1].substring(0,5)})
        .then(()=>{this.showToastNotification('ÁßªÂãï„Åó„Åæ„Åó„Åü'); this.fetchGCal();}).catch(e=>this.showInfo('Error',e)).finally(()=>this.loading=false);
    },
    // Helpers
    closePanel() { this.showPanel=false; },
    toggleTask(t) { const org=this.tasks.find(x=>x.lineIndex===t.lineIndex); if(org){org.completed=!org.completed; if(org.completed&&org.recurrence)this.generateNextTask(org); this.pushChanges();} },
    confirmDelete(t) { this.modal={show:true, title:'ÂâäÈô§', message:'Êú¨ÂΩì„Å´ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü', type:'confirm', isDanger:true, okText:'ÂâäÈô§', resolve: r=>{this.modal.show=false; if(r)this.deleteTask(t);}}; },
    // ‚òÖ Restore Archive Delete Logic ‚òÖ
    deleteTask(t) { 
        if(t.isArchived) {
             if(!this.settings.archivePath) return;
             this.loading = true; 
             this.fetchFileContent(this.settings.archivePath).then(res => {
                 const lines = (res.content || '').split('\n');
                 const newLines = lines.filter(l => l !== t.originalLine);
                 this.saveFileContentPromise(this.settings.archivePath, newLines.join('\n'), res.sha)
                 .then(() => { this.loading = false; this.showToastNotification('ÂâäÈô§„Åó„Åæ„Åó„Åü'); this.loadArchiveData(); })
                 .catch(e => { this.loading = false; this.showInfo('Error', e); });
             });
        } else {
            const idx=this.tasks.findIndex(x=>x.lineIndex===t.lineIndex); if(idx>-1){const org=this.tasks[idx]; this.tasks.splice(idx,1); if(org.lineIndex>=0){this.lines.splice(org.lineIndex,1); this.tasks.forEach(k=>{if(k.lineIndex>org.lineIndex)k.lineIndex--;}); this.pushChanges(); this.closePanel();}}
        }
    },
    confirmRestore(t) { this.modal={show:true, title:'Âæ©ÂÖÉ', message:'Êú™ÂÆå‰∫Ü„Å´Êàª„Åó„Åæ„Åô„ÅãÔºü', type:'confirm', okText:'Âæ©ÂÖÉ', resolve: r=>{this.modal.show=false; if(r){const org=this.tasks.find(x=>x.lineIndex===t.lineIndex); if(org){org.completed=false; org.doneDate=''; this.pushChanges();}}}}; },
    runArchiveProcess() { /* ... */ },
    // Utils
    getLocalYMD(d) { return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; },
    convertIsoToYMD(iso) { return iso ? this.getLocalYMD(new Date(iso)) : ''; },
    getTodayStr() { return this.getLocalYMD(new Date()); },
    formatTimeRange(item) { if(item.isAllDay) return 'ÁµÇÊó•'; const d1=new Date(item.start); const d2=new Date(item.end); return `${String(d1.getHours()).padStart(2,'0')}:${String(d1.getMinutes()).padStart(2,'0')} - ${String(d2.getHours()).padStart(2,'0')}:${String(d2.getMinutes()).padStart(2,'0')}`; },
    changeDateRange(d) { const dt=new Date(this.currentCalStart); if(this.calendarMode==='week') dt.setDate(dt.getDate()+d*7); else dt.setMonth(dt.getMonth()+d); this.currentCalStart=dt; },
    selectDate(d) { this.selectedDate = d; },
    showToastNotification(m) { this.toast.message=m; this.toast.show=true; setTimeout(()=>this.toast.show=false, 3000); },
    showInfo(t, m) { this.modal={show:true, title:t, message:m, type:'info', okText:'OK'}; },
    getEventStyle(item) { const s=new Date(item.start); const e=new Date(item.end); const sh=s.getHours()+s.getMinutes()/60; const eh=e.getHours()+e.getMinutes()/60; if(eh<=9||sh>=20)return null; return {top:(Math.max(9,sh)-9)*50+'px', height:(Math.min(20,eh)-Math.max(9,sh))*50+'px', background:item.color||'var(--primary)'}; },
    loadMoreCompleted() { this.displayLimit+=50; },
    renderDesc(t) { return t?t.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>'):''; },
    getPriorityColor(p) { return p==='high'?'#ef4444':p==='medium'?'#f59e0b':p==='low'?'#3b82f6':'#ccc'; },
    setDateShortcut(d) { const dt=new Date(); dt.setDate(dt.getDate()+d); this.panelData.due=this.getLocalYMD(dt); },
    addTagFromHistory(tag) { if(!this.panelData.tags.includes(tag)) this.panelData.tags.push(tag); },
    removeTag(t) { this.panelData.tags = this.panelData.tags.filter(tg => tg !== t); }
  }
}).mount('#app');
</script>
</body>
</html>
