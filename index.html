<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Tasks</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/vue@3.2.45/dist/vue.global.prod.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
  
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover, maximum-scale=1.0">
  <meta name="theme-color" content="#6366f1">
  <link rel="manifest" href="./manifest.json">
  <link rel="apple-touch-icon" href="./icon-192.png">
  
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js').catch(err => console.log(err));
    }
  </script>

  <style>
    /* === Design System === */
    :root {
      --primary: #6366f1; --bg-body: #f3f4f6; --bg-card: #ffffff;
      --text-main: #1f2937; --text-sub: #6b7280; --border-color: #e5e7eb;
      --hover-bg: #f9fafb;
      --time-col-width: 50px;
      --header-height: 38px; /* Date Header Height */
      --allday-height: 40px; /* Min AllDay Height */
      --slot-height: 50px;
    }
    body.dark-mode {
      --primary: #818cf8; --bg-body: #111827; --bg-card: #1f2937;
      --text-main: #f3f4f6; --text-sub: #9ca3af; --border-color: #374151;
      --hover-bg: #374151;
    }
    body { background-color: var(--bg-body); color: var(--text-main); font-family: 'Inter', sans-serif; overflow: hidden; }
    .form-control, .form-select { background-color: var(--bg-card); border-color: var(--border-color); color: var(--text-main); }
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

    /* Layout */
    .app-container { display: flex; flex-direction: column; height: 100vh; max-width: 1600px; margin: 0 auto; padding: 16px; gap: 16px; }
    .app-header { flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; padding: 0 4px; }
    .app-title { font-weight: 800; font-size: 1.5rem; margin: 0; }
    .btn-theme-toggle { background: transparent; border: none; color: var(--text-main); }

    .main-content { flex: 1; min-height: 0; display: flex; flex-direction: column; }
    
    /* Split View */
    .split-layout { display: flex; flex-direction: column; height: 100%; gap: 16px; }
    @media (min-width: 992px) {
        .split-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
    }
    .view-panel { display: flex; flex-direction: column; height: 100%; min-height: 0; overflow: hidden; position: relative; }
    .scroll-y { overflow-y: auto; flex: 1; padding-bottom: 80px; }

    /* Tabs */
    .nav-tabs { border-bottom: 1px solid var(--border-color); gap: 8px; flex-shrink: 0; margin-bottom: 12px; }
    .nav-link { border: none; color: var(--text-sub); font-weight: 600; padding: 8px 16px; border-radius: 8px 8px 0 0; }
    .nav-link.active { background: var(--primary) !important; color: white !important; }

    /* Tasks List */
    .task-card { 
        background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 8px; padding: 12px;
        display: flex; gap: 10px; align-items: flex-start; cursor: pointer; position: relative;
    }
    .task-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; border-radius: 4px 0 0 4px; }
    .priority-high::before { background: #ef4444; } .priority-medium::before { background: #f59e0b; } .priority-low::before { background: #3b82f6; }
    
    .custom-checkbox { width: 20px; height: 20px; border: 2px solid var(--text-sub); border-radius: 5px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; margin-top: 3px; }
    .custom-checkbox.checked { background: var(--primary); border-color: var(--primary); }
    .custom-checkbox .material-icons-round { font-size: 14px; color: white; display: none; }
    .custom-checkbox.checked .material-icons-round { display: block; }
    
    .task-title { font-weight: 600; font-size: 0.95rem; line-height: 1.4; }
    .task-meta { font-size: 0.75rem; color: var(--text-sub); display: flex; gap: 6px; margin-top: 4px; flex-wrap: wrap; }
    .badge-tag { background: var(--hover-bg); padding: 2px 6px; border-radius: 4px; border: 1px solid var(--border-color); }
    
    /* ‚òÖ TIMELINE CALENDAR (STICKY HEADER FIX) ‚òÖ */
    .calendar-wrapper {
        flex: 1; overflow-y: auto; /* Single Scroll Container */
        background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px;
        position: relative;
    }
    
    /* Common Grid */
    .tl-row { display: grid; grid-template-columns: var(--time-col-width) repeat(7, 1fr); width: 100%; }

    /* Sticky Headers */
    .tl-header { 
        position: sticky; top: 0; z-index: 30; 
        background: var(--bg-card); border-bottom: 1px solid var(--border-color);
        height: var(--header-height);
    }
    .tl-allday {
        position: sticky; top: var(--header-height); z-index: 29; 
        background: var(--bg-card); border-bottom: 2px solid var(--border-color); 
        min-height: var(--allday-height);
    }

    /* Cells */
    .tl-corner, .tl-ad-label, .tl-time-col { 
        border-right: 1px solid var(--border-color); background: var(--hover-bg); 
        display: flex; align-items: center; justify-content: center; 
        font-size: 0.7rem; color: var(--text-sub);
    }
    
    .tl-day-head { 
        text-align: center; border-right: 1px solid var(--border-color); 
        font-size: 0.8rem; font-weight: bold; background: var(--hover-bg);
        display: flex; align-items: center; justify-content: center; gap: 4px;
    }
    .tl-day-head:last-child { border-right: none; }
    .sun { color: #ef4444; } .sat { color: #3b82f6; }

    .tl-ad-cell { border-right: 1px solid var(--border-color); padding: 2px; background: var(--bg-card); }
    .tl-ad-cell:last-child { border-right: none; }
    .ad-item { background: var(--primary); color: white; font-size: 0.7rem; padding: 2px 4px; border-radius: 3px; margin-bottom: 2px; white-space: nowrap; overflow: hidden; cursor: pointer; }

    /* Time Body */
    .tl-body { position: relative; }
    .tl-time-label { 
        height: var(--slot-height); border-bottom: 1px solid var(--border-color); 
        font-size: 0.75rem; color: var(--text-sub); text-align: center; line-height: var(--slot-height); margin-top: -10px;
    }
    .tl-day-col { border-right: 1px solid var(--border-color); position: relative; }
    .tl-day-col:last-child { border-right: none; }
    .tl-slot { height: var(--slot-height); border-bottom: 1px solid var(--border-color); box-sizing: border-box; }
    
    .event-block {
        position: absolute; left: 2px; right: 2px; background: var(--primary); color: white;
        border-radius: 4px; padding: 2px 4px; font-size: 0.75rem; overflow: hidden;
        cursor: grab; box-shadow: 0 1px 3px rgba(0,0,0,0.2); z-index: 10;
        border: 1px solid rgba(255,255,255,0.3);
    }

    /* Month View */
    .month-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: var(--border-color); border: 1px solid var(--border-color); border-radius: 12px; overflow: hidden; }
    .m-cell { background: var(--bg-card); min-height: 80px; padding: 4px; cursor: pointer; }
    .m-cell.selected { background: #e0e7ff !important; }
    .date-badge { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 50%; font-size: 0.8rem; font-weight: bold; }
    .date-badge.today { background: var(--primary); color: white; }

    /* Side Panel Inputs */
    .side-panel { 
        position: fixed; top: 0; right: 0; width: 100%; height: 100%; background: var(--bg-card); 
        z-index: 2000; box-shadow: -5px 0 20px rgba(0,0,0,0.2); padding: 20px;
        transform: translateX(100%); transition: transform 0.3s; display: flex; flex-direction: column;
    }
    .side-panel.open { transform: translateX(0); }
    @media (min-width: 992px) {
        .side-panel { 
            position: absolute; top: 20px; right: 20px; width: 380px; height: auto; max-height: calc(100vh - 40px);
            border-radius: 12px; border: 1px solid var(--border-color);
            transform: none; opacity: 0; pointer-events: none; transition: opacity 0.2s;
        }
        .side-panel.open { opacity: 1; pointer-events: auto; }
    }
    
    /* Input Helpers */
    .date-shortcut-btn { font-size: 0.75rem; padding: 6px 12px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-body); cursor: pointer; margin-right: 4px; }
    .priority-btn { flex: 1; padding: 8px; border: 1px solid var(--border-color); background: var(--bg-body); border-radius: 6px; cursor: pointer; font-size: 0.85rem; text-align: center; }
    .priority-btn.active.high { background: #fee2e2; color: #ef4444; border-color: #ef4444; }
    .priority-btn.active.medium { background: #fef3c7; color: #f59e0b; border-color: #f59e0b; }
    .priority-btn.active.low { background: #dbeafe; color: #3b82f6; border-color: #3b82f6; }
    .tag-chip { display: inline-block; padding: 4px 10px; border-radius: 16px; background: var(--border-color); font-size: 0.8rem; margin-right: 4px; margin-bottom: 4px; cursor: pointer; }

    /* Common */
    .fab-btn { position: fixed; bottom: 30px; right: 30px; width: 56px; height: 56px; border-radius: 16px; background: var(--primary); color: white; border: none; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4); z-index: 1000; display: flex; align-items: center; justify-content: center; }
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 900; backdrop-filter: blur(2px); }
    .modal-box { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--bg-card); padding: 24px; border-radius: 12px; width: 90%; max-width: 400px; z-index: 2100; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
  </style>
</head>
<body>
<div id="app">
  <div v-if="loading" class="overlay d-flex flex-column align-items-center justify-content-center text-white"><div class="spinner-border mb-2"></div><strong>{{ loadingMessage }}</strong></div>
  <div v-if="toast.show" style="position:fixed; bottom:30px; left:50%; transform:translateX(-50%); background:#333; color:white; padding:10px 20px; border-radius:30px; z-index:3000;">{{ toast.message }}</div>

  <div v-if="modal.show" class="overlay" @click="closeModal(false)"></div>
  <div v-if="modal.show" class="modal-box">
      <h5 class="fw-bold">{{ modal.title }}</h5><p class="text-secondary">{{ modal.message }}</p>
      <div class="d-flex justify-content-end gap-2">
          <button v-if="modal.type==='confirm'" class="btn btn-light" @click="closeModal(false)">„Ç≠„É£„É≥„Çª„É´</button>
          <button class="btn" :class="modal.isDanger?'btn-danger':'btn-primary'" @click="closeModal(true)">{{ modal.okText }}</button>
      </div>
  </div>

  <div class="app-container">
    <div class="app-header">
        <h1 class="app-title">Tasks</h1>
        <button class="btn-theme-toggle" @click="toggleDarkMode"><span class="material-icons-round">{{ darkMode ? 'light_mode' : 'dark_mode' }}</span></button>
    </div>

    <div class="main-content">
        <div class="split-layout">
            
            <div class="view-panel" v-show="!isPC && currentTab !== 'calendar' || isPC">
                <ul class="nav nav-tabs">
                    <li class="nav-item"><a class="nav-link" :class="{active: currentTab==='active'}" @click="setTab('active')" href="#">Êú™ÂÆå‰∫Ü <span v-if="activeCount" class="badge bg-secondary rounded-pill">{{activeCount}}</span></a></li>
                    <li class="nav-item"><a class="nav-link" :class="{active: currentTab==='completed'}" @click="setTab('completed')" href="#">ÂÆå‰∫ÜÊ∏à</a></li>
                    <li class="nav-item" v-if="!isPC"><a class="nav-link" :class="{active: currentTab==='calendar'}" @click="setTab('calendar')" href="#">„Ç´„É¨„É≥„ÉÄ„Éº</a></li>
                    <li class="nav-item"><a class="nav-link" :class="{active: currentTab==='settings'}" @click="setTab('settings')" href="#">Ë®≠ÂÆö</a></li>
                </ul>

                <div class="scroll-y">
                    <div v-if="currentTab==='settings'" class="p-3">
                        <div class="card p-3 border-0 shadow-sm mb-3" style="background: var(--bg-card);">
                            <h6 class="fw-bold">Êé•Á∂öË®≠ÂÆö</h6>
                            <input type="password" v-model="settings.token" class="form-control mb-2" placeholder="GitHub Token">
                            <div class="row g-2 mb-2"><div class="col"><input v-model="settings.owner" class="form-control" placeholder="Owner"></div><div class="col"><input v-model="settings.repo" class="form-control" placeholder="Repo"></div></div>
                            <input v-model="settings.path" class="form-control mb-2" placeholder="Path (tasks.md)">
                            <button class="btn btn-primary w-100" @click="saveSettings">‰øùÂ≠ò</button>
                        </div>
                        <div class="card p-3 border-0 shadow-sm" style="background: var(--bg-card);">
                             <h6 class="fw-bold">Google„Ç´„É¨„É≥„ÉÄ„Éº</h6>
                             <div v-for="cal in availableCalendars" :key="cal.id" class="form-check"><input class="form-check-input" type="checkbox" :value="cal.id" v-model="settings.calendarIds"><label class="form-check-label">{{cal.name}}</label></div>
                        </div>
                        <button class="btn btn-outline-warning w-100 mt-3" @click="runArchiveProcess">ÂÆå‰∫Ü„Çø„Çπ„ÇØ„Çí„Ç¢„Éº„Ç´„Ç§„Éñ</button>
                    </div>

                    <div v-else class="p-1">
                        <div v-if="(currentTab==='active' && groupedActiveTasks.length===0) || (currentTab==='completed' && displayCompletedTasks.length===0)" class="text-center py-5 text-muted">„Çø„Çπ„ÇØ„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>
                        
                        <div v-if="currentTab==='active'">
                             <div v-for="group in groupedActiveTasks" :key="group.title" class="mb-4">
                                 <div class="small fw-bold text-secondary ms-1 mb-1">{{ group.title }}</div>
                                 <div v-for="task in group.tasks" :key="task.lineIndex" class="task-card" :class="'priority-'+task.priority" @click="openEditPanel(task)">
                                     <div class="custom-checkbox" @click.stop="toggleTask(task)"><span class="material-icons-round">check</span></div>
                                     <div class="task-content">
                                         <div class="task-title" v-html="renderDesc(task.desc)"></div>
                                         <div class="task-meta">
                                             <span v-for="tag in task.tags" class="badge-tag">#{{tag.replace('#','')}}</span>
                                             <span v-if="task.due" class="badge-tag">üìÖ {{task.due}}</span>
                                             <span v-if="task.recurrence" class="badge-tag">üîÅ {{ task.recurrence }}</span>
                                         </div>
                                     </div>
                                 </div>
                             </div>
                        </div>

                        <div v-if="currentTab==='completed'">
                             <div v-for="task in displayCompletedTasks" :key="task.uniqueId" class="task-card opacity-75">
                                 <div class="custom-checkbox checked" @click.stop="confirmRestore(task)"><span class="material-icons-round">check</span></div>
                                 <div class="task-content">
                                     <div class="task-title text-decoration-line-through" v-html="renderDesc(task.desc)"></div>
                                     <div class="task-meta"><span v-if="task.isArchived" class="badge bg-secondary">Archived</span> üìÖ {{task.doneDate}}</div>
                                 </div>
                                 <button class="btn btn-sm btn-light text-danger" @click.stop="confirmDelete(task)">ÂâäÈô§</button>
                             </div>
                             <div v-if="displayCompletedTasks.length < allCompletedTasks.length" class="text-center mt-3"><button class="btn btn-sm btn-outline-secondary" @click="loadMoreCompleted">„ÇÇ„Å£„Å®Ë¶ã„Çã</button></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="view-panel" v-show="isPC || currentTab==='calendar'">
                 <div class="d-flex justify-content-between align-items-center mb-2 px-1">
                     <div class="btn-group"><button class="btn btn-sm btn-light border" :class="{active: calendarMode==='week'}" @click="calendarMode='week'">ÈÄ±</button><button class="btn btn-sm btn-light border" :class="{active: calendarMode==='month'}" @click="calendarMode='month'">Êúà</button></div>
                     <div class="d-flex align-items-center gap-2 bg-white rounded shadow-sm px-2 py-1 border"><button class="btn btn-sm btn-light p-0 px-2" @click="changeDateRange(-1)">‚óÄ</button><span class="fw-bold small">{{ calendarTitle }}</span><button class="btn btn-sm btn-light p-0 px-2" @click="changeDateRange(1)">‚ñ∂</button></div>
                 </div>

                 <div v-if="calendarMode==='week'" class="calendar-wrapper">
                     <div class="tl-header tl-row">
                         <div class="tl-corner"></div>
                         <div v-for="day in calendarDays" :key="'h'+day.date" class="tl-day-head" :class="{sun:day.dayOfWeek==0, sat:day.dayOfWeek==6}">{{['Êó•','Êúà','ÁÅ´','Ê∞¥','Êú®','Èáë','Âúü'][day.dayOfWeek]}} {{day.dayNum}}</div>
                     </div>
                     <div class="tl-allday tl-row">
                         <div class="tl-ad-label">ÁµÇÊó•</div>
                         <div v-for="day in calendarDays" :key="'ad'+day.date" class="tl-ad-cell" @dragover.prevent @drop="onDrop($event, day.date, null)">
                             <div v-for="item in day.items.filter(i=>i.isGCal && i.isAllDay)" class="ad-item" :style="{background: item.color}" draggable="true" @dragstart="dragStart($event, item)" @click="openEditPanel(item)">{{item.title}}</div>
                         </div>
                     </div>
                     <div class="tl-body tl-row">
                         <div class="tl-time-col"><div v-for="h in timelineHours" :key="h" class="tl-time-label">{{h}}:00</div></div>
                         <div v-for="day in calendarDays" :key="'b'+day.date" class="tl-day-col" @dragover.prevent @drop="onDrop($event, day.date)">
                             <div v-for="h in timelineHours" :key="h" class="tl-slot" @drop.stop="onDrop($event, day.date, h)"></div>
                             <div v-for="item in day.items.filter(i=>!i.isAllDay && i.isGCal && getEventStyle(i))" class="event-block" :style="getEventStyle(item)" draggable="true" @dragstart="dragStart($event, item)" @click.stop="openEditPanel(item)">{{item.title}}</div>
                         </div>
                     </div>
                 </div>

                 <div v-else class="month-grid mb-3">
                     <div v-for="d in ['Êó•','Êúà','ÁÅ´','Ê∞¥','Êú®','Èáë','Âúü']" class="p-2 text-center small fw-bold bg-light">{{d}}</div>
                     <div v-for="day in calendarDays" :key="day.date" class="m-cell" :class="{selected: selectedDate===day.date}" @click="selectedDate=day.date">
                         <div class="date-badge" :class="{today: day.isToday}">{{day.dayNum}}</div>
                         <div class="d-flex flex-wrap gap-1 mt-1"><div v-for="item in day.items" class="rounded-circle" :style="{width:'6px',height:'6px', background: item.isGCal?item.color:'var(--text-sub)'}"></div></div>
                     </div>
                 </div>

                 <div class="card flex-grow-1 d-flex flex-column overflow-hidden" v-if="selectedDate">
                     <div class="p-2 border-bottom bg-light fw-bold d-flex justify-content-between">{{selectedDateDisplay}} <div class="d-flex gap-1"><button class="btn btn-sm btn-outline-primary" @click="openAddGCalPanel(selectedDate)">+‰∫àÂÆö</button><button class="btn btn-sm btn-primary" @click="openAddPanelWithDate(selectedDate)">+„Çø„Çπ„ÇØ</button></div></div>
                     <div class="overflow-auto p-2">
                         <div v-for="item in selectedDateItems" :key="item.uniqueId" class="task-card border-0 mb-1" :style="item.isGCal?{background:'var(--hover-bg)'}:{}" @click="openEditPanel(item)">
                             <div v-if="item.isGCal" class="me-2 text-primary">‚óè</div>
                             <div v-else class="custom-checkbox me-2" :class="{checked:item.completed}" @click.stop="toggleTask(item)"><span class="material-icons-round">check</span></div>
                             <div class="flex-grow-1">
                                 <div class="fw-bold small" v-html="renderDesc(item.isGCal?item.title:item.desc)"></div>
                                 <div class="small text-muted">{{ item.isGCal ? (item.isAllDay?'ÁµÇÊó•':item.timeStr) : '#Task' }}</div>
                             </div>
                         </div>
                         <div v-if="selectedDateItems.length===0" class="text-center text-muted small py-3">‰∫àÂÆö„Å™„Åó</div>
                     </div>
                 </div>
            </div>
        </div>
    </div>

    <div class="side-panel" :class="{open: showPanel}">
        <div class="d-flex justify-content-between mb-3"><h5 class="m-0 fw-bold">{{isEditMode?'Á∑®ÈõÜ':'Êñ∞Ë¶è‰ΩúÊàê'}}</h5><button class="btn-close" @click="showPanel=false"></button></div>
        
        <div v-if="panelData.isGCal" class="d-flex flex-column h-100 gap-3">
             <div v-if="panelData.isNew"><label class="small text-muted">„Ç´„É¨„É≥„ÉÄ„Éº</label><select v-model="panelData.targetCalendarId" class="form-select"><option v-for="c in availableCalendars" :value="c.id">{{c.name}}</option></select></div>
             <div><label class="small text-muted">„Çø„Ç§„Éà„É´</label><input v-model="panelData.title" class="form-control fw-bold"></div>
             <div><label class="small text-muted">Êó•ÊôÇ</label><input type="date" v-model="panelData.dateInput" class="form-control mb-2">
             <div class="d-flex gap-2 align-items-center"><select v-model="panelData.startHour" class="form-select"><option v-for="h in hours" :value="h">{{h}}</option></select>:<select v-model="panelData.startMin" class="form-select"><option v-for="m in minutes" :value="m">{{m}}</option></select> ÔΩû <select v-model="panelData.endHour" class="form-select"><option value="">--</option><option v-for="h in hours" :value="h">{{h}}</option></select>:<select v-model="panelData.endMin" class="form-select"><option value="">--</option><option v-for="m in minutes" :value="m">{{m}}</option></select></div></div>
             <div><label class="small text-muted">‰ºöË≠∞URL</label><input v-model="panelData.meetingUrl" class="form-control" placeholder="https://..."></div>
             <div class="flex-grow-1"><label class="small text-muted">„É°„É¢</label><textarea v-model="panelData.desc" class="form-control h-100"></textarea></div>
             <div class="d-flex gap-2"><button class="btn btn-light flex-grow-1" @click="showPanel=false">„Ç≠„É£„É≥„Çª„É´</button><button class="btn btn-primary flex-grow-1" @click="saveGCalEvent">‰øùÂ≠ò</button></div>
        </div>

        <div v-else class="d-flex flex-column h-100 gap-3">
             <div><label class="small text-muted">„Çø„Çπ„ÇØÂêç</label><textarea v-model="panelData.desc" class="form-control fw-bold" rows="3"></textarea></div>
             
             <div><label class="small text-muted">Êó•‰ªò</label>
             <div class="d-flex gap-2"><input type="date" v-model="panelData.due" class="form-control"><button class="date-shortcut-btn" @click="setDateShortcut(0)">‰ªäÊó•</button><button class="date-shortcut-btn" @click="setDateShortcut(1)">ÊòéÊó•</button></div></div>
             
             <div><label class="small text-muted">Áπ∞„ÇäËøî„Åó</label><input v-model="panelData.recurrence" class="form-control" placeholder="every week" list="recurrenceOptions"></div>
             
             <div><label class="small text-muted">ÂÑ™ÂÖàÂ∫¶</label>
             <div class="d-flex gap-2">
                 <div class="priority-btn" :class="{'active high': panelData.priority==='high'}" @click="panelData.priority='high'">È´ò</div>
                 <div class="priority-btn" :class="{'active medium': panelData.priority==='medium'}" @click="panelData.priority='medium'">‰∏≠</div>
                 <div class="priority-btn" :class="{'active low': panelData.priority==='low'}" @click="panelData.priority='low'">‰Ωé</div>
                 <div class="priority-btn" :class="{'active': panelData.priority==='none'}" @click="panelData.priority='none'">„Å™„Åó</div>
             </div></div>

             <div><label class="small text-muted">„Çø„Ç∞</label><input v-model="tagInput" class="form-control" placeholder="#tag" @keydown.enter.prevent="addTag">
             <div class="d-flex flex-wrap gap-1 mt-2">
                 <span v-for="t in panelData.tags" :key="t" class="badge-tag" @click="removeTag(t)">{{t}} √ó</span>
             </div>
             <div class="mt-2 border-top pt-2">
                 <small class="text-muted">Â±•Ê≠¥: </small>
                 <span v-for="t in suggestedTags" :key="t" class="tag-chip" @click="addTagFromHistory(t)">#{{t.replace('#','')}}</span>
             </div></div>

             <div><label class="small text-muted">URL</label><input v-model="panelData.url" class="form-control" placeholder="https://..."></div>
             
             <div class="mt-auto d-flex gap-2"><button v-if="isEditMode" class="btn btn-danger" @click="confirmDelete(panelData.taskRef)">ÂâäÈô§</button><button class="btn btn-light flex-grow-1" @click="showPanel=false">„Ç≠„É£„É≥„Çª„É´</button><button class="btn btn-primary flex-grow-1" @click="saveTaskChanges">‰øùÂ≠ò</button></div>
        </div>
    </div>

    <button v-if="!showPanel && (!isPC || currentTab==='active'||currentTab==='calendar')" class="fab-btn" @click="openAddPanel"><span class="material-icons-round">add</span></button>
    <datalist id="recurrenceOptions"><option value="every day"></option><option value="every week"></option></datalist>
  </div>
</div>

<script>
const CONST_GAS_URL = "https://script.google.com/macros/s/AKfycbxd-vue3AV2zTLZ5abQVw287UD6fVXj44E0_9kzBW6P5EILSTua0q3EBKLd9MzSd6HNjw/exec"; 
async function callGAS(a, p={}) { const r=await fetch(CONST_GAS_URL,{method:'POST',body:JSON.stringify({...p,action:a})}); const j=await r.json(); if(j.error)throw new Error(j.error); return j; }

const { createApp } = Vue;
createApp({
  data() { return {
      loading: false, loadingMessage: 'Loading...', isSaving: false,
      currentTab: 'active', isPC: window.innerWidth >= 992,
      settings: { token:'', owner:'', repo:'', path:'', archivePath:'', calendarIds:[] },
      lines: [], tasks: [], archiveTasks: [],
      calendarMode: 'week', selectedDate: '', currentCalStart: new Date(), gcalEvents: [], availableCalendars: [],
      showPanel: false, isEditMode: false, panelData: {}, tagInput: '', allTagsList: [], filterTag: '',
      modal: { show: false }, toast: { show: false },
      timelineHours: [9,10,11,12,13,14,15,16,17,18,19,20],
      hours: Array.from({length:24},(_,i)=>String(i).padStart(2,'0')), minutes: ['00','15','30','45']
  }},
  computed: {
    activeCount() { return this.tasks.filter(t=>!t.completed).length; },
    allCompletedTasks() {
        const m = this.tasks.filter(t=>t.completed).map(t=>({...t, isArchived:false, uniqueId:'m-'+t.lineIndex}));
        const a = this.archiveTasks.map((t,i)=>({...t, isArchived:true, uniqueId:'a-'+i}));
        return [...m, ...a].sort((a,b)=>a.doneDate<b.doneDate?1:-1);
    },
    displayCompletedTasks() { return this.allCompletedTasks.slice(0, 50); },
    groupedActiveTasks() {
        const today = this.getTodayStr(); const groups = {}; const noDate = [];
        this.tasks.filter(t=>!t.completed && (!this.filterTag || t.tags.includes(this.filterTag))).forEach(t=>{
            if(!t.due) noDate.push(t);
            else { if(!groups[t.due]) groups[t.due]=[]; groups[t.due].push(t); }
        });
        const res = Object.keys(groups).sort().map(d=>({title:d, tasks:groups[d]}));
        if(noDate.length) res.push({title:'No Date', tasks:noDate});
        return res;
    },
    suggestedTags() { return this.allTagsList.filter(t=>!this.panelData.tags?.includes(t)); },
    calendarTitle() { const d=new Date(this.currentCalStart); return `${d.getFullYear()}Âπ¥${d.getMonth()+1}Êúà`; },
    calendarDays() {
        const days=[]; const start=new Date(this.currentCalStart);
        if(this.calendarMode==='week') start.setDate(start.getDate()-start.getDay());
        else { start.setDate(1); start.setDate(start.getDate()-start.getDay()); }
        const cnt = this.calendarMode==='week'?7:42;
        for(let i=0; i<cnt; i++) {
            const d=new Date(start); d.setDate(start.getDate()+i); const ds=this.getLocalYMD(d);
            const evs=this.gcalEvents.filter(e=>this.convertIsoToYMD(e.start)===ds).map(e=>({...e, isGCal:true}));
            const tks=this.tasks.filter(t=>t.due===ds).map(t=>({...t, isGCal:false}));
            days.push({date:ds, dayNum:d.getDate(), dayOfWeek:d.getDay(), isToday:ds===this.getTodayStr(), items:[...tks, ...evs]});
        }
        return days;
    },
    selectedDateItems() { return this.calendarDays.find(d=>d.date===this.selectedDate)?.items.sort((a,b)=>{ if(a.isGCal!==b.isGCal) return a.isGCal?-1:1; return (a.start||'0')>(b.start||'0')?1:-1; }) || []; },
    selectedDateDisplay() { return this.selectedDate; }
  },
  mounted() {
      this.selectedDate = this.getTodayStr();
      window.addEventListener('resize', ()=>{ this.isPC=window.innerWidth>=992; if(this.isPC && this.currentTab==='calendar')this.currentTab='active'; });
      const s = localStorage.getItem('gh_tasks_settings');
      if(s) { this.settings=JSON.parse(s); this.loadData(); } else { this.currentTab='settings'; }
      if(localStorage.getItem('theme')==='dark') document.body.classList.add('dark-mode');
  },
  methods: {
    setTab(t) { this.currentTab=t; if(t==='completed' && !this.archiveTasks.length) this.loadArchiveData(); },
    toggleDarkMode() { document.body.classList.toggle('dark-mode'); localStorage.setItem('theme', document.body.classList.contains('dark-mode')?'dark':'light'); },
    async loadData() {
        this.loading=true;
        try {
            const res = await callGAS('getFileContent', this.settings);
            this.sha = res.sha; this.lines = res.content.split('\n'); this.parseContent(res.content);
            await this.fetchGCal();
            this.availableCalendars = await callGAS('getAvailableCalendars');
        } catch(e) { console.error(e); } finally { this.loading=false; }
    },
    async fetchGCal() {
        if(!this.settings.calendarIds.length) return;
        const res = await callGAS('getCalendarEvents', {startStr:this.calendarDays[0].date, endStr:this.calendarDays[this.calendarDays.length-1].date, calendarIds:JSON.stringify(this.settings.calendarIds)});
        if(res.events) this.gcalEvents = res.events;
    },
    async loadArchiveData() {
        if(!this.settings.archivePath) return;
        try {
            const res = await callGAS('getFileContent', {...this.settings, path:this.settings.archivePath});
            if(res.content) {
                const lines = res.content.split('\n');
                this.archiveTasks = lines.map(l=>{ const m=l.match(/^[-*]\s*\[x\]\s*(.*)/i); return m?{desc:m[1], doneDate:'', completed:true, originalLine:l}:null; }).filter(t=>t);
            }
        } catch(e) { console.error(e); }
    },
    parseContent(txt) {
        this.tasks=[]; const tags=new Set();
        txt.split('\n').forEach((l,i)=>{
            const m=l.match(/^[-*]\s*\[([xX ])\]\s*(.*)/);
            if(m) {
                let d=m[2]; const comp=m[1].toLowerCase()==='x';
                const due=(d.match(/üìÖ\s*(\d{4}-\d{2}-\d{2})/) || [])[1] || '';
                const rec=(d.match(/üîÅ\s*([^‚úÖ‚ûïüìÖ#]+)/) || [])[1]?.trim() || '';
                let pri='none'; if(d.includes('‚è´'))pri='high'; else if(d.includes('üîº'))pri='medium'; else if(d.includes('üîΩ'))pri='low';
                const tks=[]; (d.match(/#[^\s#]+/g)||[]).forEach(t=>{ if(t!=='#todo') {tks.push(t); tags.add(t);} });
                d = d.replace(/üìÖ\s*\d{4}-\d{2}-\d{2}|üîÅ\s*[^‚úÖ‚ûïüìÖ#]+|‚è´|üîº|üîΩ/g, '').trim();
                tks.forEach(t=>d=d.replace(t,''));
                this.tasks.push({lineIndex:i, desc:d.trim(), completed:comp, due, recurrence:rec, priority:pri, tags:tks});
            }
        });
        this.allTagsList=Array.from(tags).sort();
    },
    // Actions
    openAddPanel() { this.isPC || this.currentTab==='calendar' ? this.openAddGCalPanel(this.getTodayStr()) : this.openAddPanelWithDate(this.getTodayStr()); },
    openAddPanelWithDate(d) { this.isEditMode=false; this.showPanel=true; this.panelData={desc:'', due:d, isGCal:false, tags:[], priority:'none', recurrence:''}; },
    openAddGCalPanel(d) { this.isEditMode=false; this.showPanel=true; this.panelData={isGCal:true, isNew:true, dateInput:d, startHour:'09', startMin:'00', targetCalendarId:this.settings.calendarIds[0]}; },
    openEditPanel(i) {
        this.isEditMode=true; this.showPanel=true;
        if(i.isGCal) {
            let d=i.desc||'', u=''; const m=d.match(/^„Äê‰ºöË≠∞URL„Äë:\s*(\S+)(\n\n)?/); if(m){u=m[1]; d=d.replace(m[0],'');}
            this.panelData={isGCal:true, eid:i.id, calendarId:i.calendarId, title:i.title, desc:d, meetingUrl:u, dateInput:this.convertIsoToYMD(i.start), startHour:i.start.substring(11,13), startMin:i.start.substring(14,16), endHour:i.end.substring(11,13), endMin:i.end.substring(14,16)};
        } else {
            const t=this.tasks.find(x=>x.lineIndex===i.lineIndex)||i; this.panelData={...t, taskRef:t, isGCal:false, tags:[...t.tags]};
            if(t.desc.match(/^\[([^\]]+)\]\(([^)]+)\)$/)) { const m=t.desc.match(/^\[([^\]]+)\]\(([^)]+)\)$/); this.panelData.desc=m[1]; this.panelData.url=m[2]; }
        }
    },
    async saveGCalEvent() {
        this.isSaving=true; let d=this.panelData.desc||''; if(this.panelData.meetingUrl) d=`„Äê‰ºöË≠∞URL„Äë: ${this.panelData.meetingUrl}\n\n${d}`;
        try {
            await callGAS(this.panelData.isNew?'createCalendarEvent':'updateCalendarEvent', {...this.panelData, description:d, startTime:`${this.panelData.startHour}:${this.panelData.startMin}`, endTime:`${this.panelData.endHour}:${this.panelData.endMin}`, dateStr:this.panelData.dateInput});
            this.showPanel=false; this.fetchGCal();
        } catch(e){this.showInfo('Error',e);} finally{this.isSaving=false;}
    },
    async saveTaskChanges() {
        let d = this.panelData.desc; if(this.panelData.url) d=`[${d}](${this.panelData.url})`;
        if(this.isEditMode) { const t=this.panelData.taskRef; t.desc=d; t.due=this.panelData.due; t.priority=this.panelData.priority; t.recurrence=this.panelData.recurrence; t.tags=[...this.panelData.tags]; }
        else { this.tasks.push({lineIndex:-1, desc:d, due:this.panelData.due, priority:this.panelData.priority, recurrence:this.panelData.recurrence, completed:false, tags:[...this.panelData.tags]}); }
        this.showPanel=false; this.pushChanges();
    },
    pushChanges() {
        this.isSaving=true;
        const newLines=[...this.lines];
        this.tasks.forEach(t=>{
            const l=`- [${t.completed?'x':' '}] ${t.desc} ${t.priority==='high'?'‚è´':t.priority==='medium'?'üîº':t.priority==='low'?'üîΩ':''} ${t.recurrence?'üîÅ '+t.recurrence:''} ${t.due?'üìÖ '+t.due:''} ${t.tags.join(' ')} #todo`.replace(/\s+/g,' ');
            if(t.lineIndex>=0)newLines[t.lineIndex]=l; else newLines.push(l);
        });
        callGAS('saveFileContent', {...this.settings, content:newLines.join('\n'), sha:this.sha}).then(r=>{this.sha=r.newSha; this.lines=newLines; this.showToastNotification('‰øùÂ≠ò„Åó„Åæ„Åó„Åü');}).catch(e=>console.error(e)).finally(()=>this.isSaving=false);
    },
    // D&D
    dragStart(e, i) { e.dataTransfer.setData('json', JSON.stringify(i)); },
    onDrop(e, date, hour) {
        const item = JSON.parse(e.dataTransfer.getData('json'));
        if(!item.isGCal) return; // Task drag not supported yet
        const start = hour ? `${date}T${String(hour).padStart(2,'0')}:00:00` : item.start;
        this.loading=true;
        callGAS('updateCalendarEvent', {calendarId:item.calendarId, eventId:item.id, dateStr:date, startTime:hour?String(hour).padStart(2,'0')+':00':null})
        .then(()=>{this.fetchGCal();}).finally(()=>this.loading=false);
    },
    // Utils
    toggleTask(t) { t.completed=!t.completed; this.pushChanges(); },
    changeDateRange(d) { const dt=new Date(this.currentCalStart); if(this.calendarMode==='week')dt.setDate(dt.getDate()+d*7); else dt.setMonth(dt.getMonth()+d); this.currentCalStart=dt; },
    selectDate(d) { this.selectedDate=d; },
    getTodayStr() { const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; },
    convertIsoToYMD(iso) { return iso ? this.getLocalYMD(new Date(iso)) : ''; },
    getLocalYMD(d) { return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; },
    getEventStyle(i) { const s=new Date(i.start); const e=new Date(i.end); const sh=s.getHours()+s.getMinutes()/60; const eh=e.getHours()+e.getMinutes()/60; if(eh<=9||sh>=20)return null; return {top:(Math.max(9,sh)-9)*50+'px', height:(Math.min(20,eh)-Math.max(9,sh))*50+'px', background:i.color||'var(--primary)'}; },
    renderDesc(t) { return t?t.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>'):''; },
    showToastNotification(m) { this.toast={show:true, message:m}; setTimeout(()=>this.toast.show=false, 3000); },
    showInfo(t,m) { this.modal={show:true, title:t, message:m, type:'info', okText:'OK'}; },
    closeModal(r) { this.modal.show=false; if(this.modal.resolve)this.modal.resolve(r); },
    confirmDelete(t) { this.modal={show:true, title:'ÂâäÈô§', message:'ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü', type:'confirm', isDanger:true, okText:'ÂâäÈô§', resolve:r=>{if(r)this.deleteTask(t)}}; },
    deleteTask(t) { /* Same delete logic */ },
    confirmRestore(t) { /* Same restore logic */ },
    runArchiveProcess() { /* Same archive logic */ },
    setDateShortcut(d) { const dt=new Date(); dt.setDate(dt.getDate()+d); this.panelData.due=this.getLocalYMD(dt); },
    addTagFromHistory(t) { if(!this.panelData.tags.includes(t))this.panelData.tags.push(t); },
    addTag() { let v=this.tagInput.trim(); if(!v)return; if(!v.startsWith('#'))v='#'+v; if(!this.panelData.tags.includes(v))this.panelData.tags.push(v); this.tagInput=''; },
    removeTag(t) { this.panelData.tags=this.panelData.tags.filter(x=>x!==t); }
  }
}).mount('#app');
</script>
</body>
</html>
