開発環境をAntigravityへ移行されるとのこと、承知いたしました。新しい環境のGeminiがスムーズに開発を引き継げるよう、現時点（Ver 31.0）でのシステム仕様書を詳細に作成します。

このドキュメントは、**フロントエンド（Vue.js/HTML/CSS）**、**バックエンド（Google Apps Script）**、そして**データ構造と処理ロジック**のすべてを網羅しています。

---

# Tasks アプリケーション システム詳細仕様書 (Ver 31.0)

## 1. システム概要

本システムは、**GitHub上のMarkdownファイル**をデータベースとして利用するタスク管理機能と、**Google Calendar**と連携するスケジュール管理機能を統合した、レスポンシブWebアプリケーション（PWA対応）である。

* **フロントエンド:** HTML5, CSS3 (Bootstrap 5 + Custom), Vue.js 3 (CDN版)
* **バックエンド:** Google Apps Script (GAS)
* **データストア:** GitHub (タスクデータ), Google Calendar (スケジュールデータ)
* **認証:** GitHub Personal Access Token (タスク用), GAS Web AppデプロイによるGoogleアカウント認証 (カレンダー用)

---

## 2. アーキテクチャ構成

### 2.1 データフロー図

```mermaid
[Client Browser (Vue.js)]
      |
      | (JSON via POST)
      v
[Google Apps Script (GAS Web App)]
      |
      +--- [Action: get/saveFileContent] ---> [GitHub API] <---> [Tasks.md / Archive.md]
      |
      +--- [Action: get/create/updateCalendarEvent] ---> [Google Calendar API] <---> [Google Calendar]

```

### 2.2 ファイル構成

* **index.html:** アプリケーションの全ロジック（HTML/CSS/JS）を含む単一ファイル。
* **Code.gs (GAS):** GitHub APIとの通信およびGoogle Calendar操作を行うAPIエンドポイント。

---

## 3. フロントエンド仕様 (Vue.js)

### 3.1 状態管理 (Data Model)

Vueインスタンスの `data` オブジェクトで管理される主要な状態変数は以下の通り。

| 変数名 | 型 | 説明 |
| --- | --- | --- |
| `settings` | Object | GitHubトークン, リポジトリ情報, ファイルパス, カレンダーID配列を保持。`localStorage` に保存される。 |
| `tasks` | Array | GitHubからパースされたタスクオブジェクトの配列。 |
| `lines` | Array | `Tasks.md` の全行データ（未パースの行も含む）。保存時の再構築に使用。 |
| `sha` | String | GitHubファイルの現在のSHAハッシュ（競合防止用）。 |
| `gcalEvents` | Array | 取得したGoogleカレンダーのイベント配列。 |
| `calendarMode` | String | `'week'` (タイムライン) または `'month'` (月表示)。 |
| `selectedDate` | String | 現在選択中の日付 (YYYY-MM-DD形式)。 |
| `panelData` | Object | 編集・新規登録パネルのフォームデータ（タスク/カレンダー共通）。 |
| `status` | Object | トースト通知の状態 (`visible`, `type`, `message`)。 |

### 3.2 画面構成とコンポーネント

#### A. レイアウト (Responsive)

* **PC (幅 >= 992px):** `split-layout` 適用。左側に「タスクリスト/設定」、右側に「カレンダー/タイムライン」を常時表示。
* **Mobile:** タブ切り替え式。画面上部の `mobile-nav` で「未完了/完了済/カレンダー/設定」を切り替え。

#### B. タスクリスト (`active`, `completed` タブ)

* **表示ロジック:**
* **未完了:** `groupedActiveTasks` により、「今日＆期限切れ」「期限なし」「未来の日付」にグループ化して表示。
* **完了:** `displayCompletedTasks` により、完了日時の降順で表示。アーカイブ済み（ファイルから消去済み）のタスクは表示しない。


* **タスクカード:**
* チェックボックス: クリックで完了状態をトグル（即時保存）。
* タイトル: Obsidian Tasks形式のメタデータ（`📅`, `🔁`, `⏫`等）を除去して表示。URLが含まれる場合はリンク化。
* タグ/期限: バッジとして表示。



#### C. カレンダー (`calendar` タブ)

* **週表示 (Timeline):**
* **構造:** Flexboxベース。左端に時間軸、右側に7日分の列。
* **表示範囲:** 9:00 〜 20:00 に固定。
* **スクロール:** 縦方向スクロール可能。初期表示時に9:00位置へ自動スクロール。
* **配置計算:** `getEventPos` メソッドにより、開始・終了時刻から `top` (px) と `height` (px) を計算して絶対配置。
* **ドラッグ＆ドロップ:** 予定のドラッグ移動に対応。移動量（時間差）を計算し、終了時刻も自動調整して更新。


* **月表示:**
* 7列のグリッド表示。各セルに日付と、予定・タスクの有無を示すドットを表示。


* **下段リスト:** 選択した日付のタスクと予定を時系列順にリスト表示。

#### D. 編集/新規登録パネル (`side-panel`)

* **モード切替:** パネル上部のスイッチで「タスク」と「カレンダー」を切り替え可能。
* **タスクモード:** タイトル、日付（ショートカットあり）、繰り返し、優先度、タグ、URLを入力可能。
* **カレンダーモード:** カレンダー選択（新規時）、タイトル、日時（終日チェックあり）、会議URL、メモを入力可能。
* **修正時の挙動:** 既存予定の編集時はカレンダーIDを固定表示（変更不可）。



---

## 4. データ処理ロジック詳細

### 4.1 タスクのパースと保存 (Obsidian Tasks形式)

本システムは `Obsidian Tasks` プラグイン互換のMarkdown形式を採用している。

* **読み込み (`parseContent`):**
* 正規表現 `^[-*]\s*\[([xX ])\]\s*(.*)` でタスク行を抽出。
* メタデータの抽出:
* 期限: `📅 YYYY-MM-DD`
* 繰り返し: `🔁 rule`
* 完了日: `✅ YYYY-MM-DD`
* 優先度: `⏫` (高), `🔼` (中), `🔽` (低)
* タグ: `#tag`




* **クレンジング (`cleanRawTitle`):**
* 編集パネル表示時および保存前に、タイトル文字列から上記のメタデータ文字をすべて除去し、プレーンなタイトルを抽出する。
* Markdownリンク `[title](url)` がある場合、タイトルとURLに分離する。


* **書き込み (`pushChanges`):**
* ユーザー入力値を元に、メタデータ文字を再構築して行末に付与する。
* 完了時は自動的に `✅ 今日` の日付を付与する。
* 行の構成: `- [x] タイトル [URL] 優先度 繰り返し 期限 完了日 タグ #todo`



### 4.2 アーカイブ処理 (`runArchiveProcess`)

1. **読み込み:** メインファイル（Tasks.md）を取得。
2. **分離:** 行ごとに解析し、「完了済み（`-[x]`）」行と「未完了」行に分ける。
3. **追記:** 設定されたアーカイブファイル（Archive.md）を取得し、末尾に完了済み行を追記して保存。
4. **削除:** メインファイルから完了済み行を削除した状態で上書き保存。
5. **更新:** 画面をリロード。

### 4.3 カレンダー操作

* **データ取得 (`fetchGCal`):** 現在表示中の期間（週または月）の開始日・終了日を計算し、GASへリクエスト。
* **ID問題の回避 (`updateCalendarEvent` @ GAS):**
* iOS/Mac等から同期されたイベントは `getEventById` で取得できない場合がある。
* **対策:** ID指定で取得失敗時、対象日の全イベントを取得し、IDの部分一致（または完全一致）で探索するロジックを実装済み。


* **終日・時間指定の自動判別:**
* フロントエンドから `isAllDay` フラグまたは `startTime: null` を送信することで、GAS側で `createAllDayEvent` と `createEvent` を使い分ける。



---

## 5. バックエンド仕様 (Google Apps Script)

### 5.1 API エンドポイント (`doPost`)

単一のエンドポイントに対し、JSONボディ内の `action` パラメータで処理を分岐する。

| Action名 | パラメータ | 処理内容 |
| --- | --- | --- |
| `getFileContent` | `path`, `token`, `owner`, `repo` | GitHub API経由でファイル内容を取得 (GET)。 |
| `saveFileContent` | `path`, `content`, `sha`, ... | GitHub API経由でファイルを更新 (PUT)。SHAによる競合チェックを行う。409エラー時はリトライロジックあり。 |
| `getAvailableCalendars` | なし | ユーザーがアクセス可能な全カレンダーのIDと名称リストを取得。 |
| `getCalendarEvents` | `startStr`, `endStr`, `calendarIds` | 指定期間・指定カレンダーのイベントを一括取得。 |
| `createCalendarEvent` | `targetCalendarId`, `title`, `dateStr`, `startTime`... | 新規イベントを作成。 |
| `updateCalendarEvent` | `calendarId`, `eid`, `title`, `dateStr`... | 既存イベントを更新。ID検索のフォールバック機能付き。 |

### 5.2 エラーハンドリング

* **JSONパースエラー:** 不正なリクエストボディに対しエラー詳細を返却。
* **GitHub APIエラー:** ステータスコードに応じたエラーメッセージを返却。
* **カレンダーID不足:** 必須パラメータ欠落時に明示的なエラーを返却。

---

## 6. 移行時の注意点・設定手順

Antigravity環境のGeminiへ引き継ぐ際は、以下の手順を実行させてください。

1. **GASのデプロイ:**
* 提供済みの「Ver 3.0 (検索強化版)」のコードを新しいGASプロジェクトに貼り付ける。
* 「ウェブアプリとして導入」を行い、アクセス権限を「自分のみ」または「全員（認証あり）」に設定。
* **発行されたWeb App URL** を控える。


2. **フロントエンド設定:**
* `index.html` 内の `CONST_GAS_URL` 定数を、上記で発行した新しいURLに書き換える。
* 必要に応じて `manifest.json` やアイコン画像 (`icon-192.png`) を配置する。


3. **初期設定 (ブラウザ上):**
* アプリ起動後、「設定」タブにて以下を入力する。
* **GitHub Token:** `repo` スコープを持つPersonal Access Token。
* **Owner/Repo:** タスクファイルを保存するリポジトリ情報。
* **File Path:** `Tasks.md` (例)
* **Archive Path:** `Archive.md` (例)


* 「保存」を押すと、自動的にカレンダーリストが読み込まれるので、表示したいカレンダーにチェックを入れる。



---

## 7. 既知の制約事項

* **タスクの並び替え:** 現在は自動ソート（日付順/完了順）のみで、ドラッグ＆ドロップによる手動並び替え機能はない。
* **サブタスク:** インデントされたリスト（サブタスク）は、単純なテキスト行として扱われる（親タスクとの連動機能はない）。
* **カレンダー移動:** 週表示でのドラッグ移動は、あくまで「同じ日付内」または「表示されている週内」に限られる。週をまたぐドラッグ移動は未対応。

以上が現在のシステム仕様の全容です。この情報を元に、Antigravity環境での開発を継続してください。